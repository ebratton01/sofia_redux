<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sofia_redux.instruments.forcast.calcvar &#8212; sofia_redux v1.3.4.dev0</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    
    <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js?v=602f4d50"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://www.sofia.usra.edu/"></a></li>
    <li><a title="General Index" href="../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../index.html">sofia_redux v1.3.4.dev0</a>
	 &#187;
      </li>
      <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sofia_redux.instruments.forcast.calcvar</h1><div class="highlight"><pre>
<span></span># Licensed under a 3-clause BSD style license - see LICENSE.rst

from astropy import log
from astropy.io import fits
import numpy as np

from sofia_redux.toolkit.utilities.fits import hdinsert, href, add_history_wrap

from sofia_redux.instruments.forcast.getpar import getpar

addhist = add_history_wrap(&#39;Calcvar&#39;)

__all__ = [&#39;calcvar&#39;]


<div class="viewcode-block" id="calcvar"><a class="viewcode-back" href="../../../../api/sofia_redux.instruments.forcast.calcvar.calcvar.html#sofia_redux.instruments.forcast.calcvar.calcvar">[docs]</a>def calcvar(data, header):
    &quot;&quot;&quot;
    Calculate read and poisson noise of the variance from raw FORCAST images

    Calculates the read noise and poisson noise components of the variance
    from raw FORCAST images.  The following equation is used to derive the
    variance for each pixel:

        V = N * betaG/g + RN^2/g^2

    where V is the variance, N is the raw ADU in each pixel, betaG is
    the excess noise factor, g is the fain, and RN is the read noise
    in electrons.  g comes from the EPERADU keyword in the FITS header.
    RN is determined by the instrument team, but its value depends on
    the capacitance setting (recorded in the ILOWCAP keyword in the FITS
    header).  betaG is also determined by the instrument team.

    Parameters
    ----------
    data : numpy.ndarray
        Raw image array
    header : astropy.io.fits.header.Header
        Raw image header; will be updated with HISTORY message and keywords

    Returns
    -------
    numpy.ndarray
        Image array with the same dimensions as the input raw image
        containing the calculated variance.
    &quot;&quot;&quot;
    if not isinstance(data, np.ndarray) or len(data.shape) not in [2, 3]:
        addhist(header, &#39;Did not calculate variance (Invalid data)&#39;)
        log.error(&quot;must provide valid data array&quot;)
        return

    if not isinstance(header, fits.header.Header):
        log.error(&quot;must provide valid header&quot;)
        return

    rn_high = getpar(header, &#39;RN_HIGH&#39;, dtype=float, default=2400.,
                     comment=&quot;Read noise for high capacitance mode&quot;)
    rn_low = getpar(header, &#39;RN_LOW&#39;, dtype=float, default=244.8,
                    comment=&quot;Read noise for low capacitance mode&quot;)
    beta_g = getpar(header, &#39;BETA_G&#39;, dtype=float, default=1.0,
                    comment=&quot;Excess noise&quot;)
    eperadu = getpar(header, &#39;EPERADU&#39;, dtype=float, default=136)
    ilowcap = getpar(header, &#39;ILOWCAP&#39;, dtype=int, default=1)
    rn = rn_low if ilowcap else rn_high

    detitime = getpar(header, &#39;DETITIME&#39;, dtype=float, default=-1)
    if detitime &lt; 0:
        log.error(&quot;Missing detector integration time (DETITIME)&quot;)
        hdinsert(header, &#39;HISTORY&#39;,
                 &quot;Did not calculate variance (Invalid header)&quot;, refkey=href)
        return
    integ = detitime / 2.0

    frmrate = getpar(header, &#39;FRMRATE&#39;, dtype=float, default=-1)
    if frmrate &lt; 0:
        log.error(&quot;Missing frame rate (FRMRATE)&quot;)
        hdinsert(header, &#39;HISTORY&#39;,
                 &quot;Did not calculate variance (Invalid header)&quot;, refkey=href)
        return

    history = [&#39;Read noise is %s&#39; % rn,
               &#39;Excess noise factor is %s&#39; % beta_g,
               &#39;Gain is %s&#39; % eperadu,
               &#39;Integration time is %s&#39; % integ,
               &#39;Variance for raw data is calculate from&#39;,
               &#39;V = N*betaG/(FR*t*g) + RN^2/(FR*t*g^2), where&#39;,
               &#39;N is the raw ADU per frame in each pixel,&#39;,
               &#39;betaG is the excess noise factor,&#39;,
               &#39;FR is the frame rate, t is the integration time,&#39;,
               &#39;g is the gain, and RN is the &#39;,
               &#39;read noise in electrons&#39;]

    # For older data DETITIME did not account for chop efficiency.
    # These data can be distinguished by the unpopulated NODTIME keyword
    nodtime = getpar(header, &#39;NODTIME&#39;, update_header=False, default=-9999,
                     dtype=int)
    if nodtime == -9999:
        history.extend([&quot;integration time may be&quot;,
                        &quot;overestimated for early FORCAST data&quot;])

    for line in history:
        hdinsert(header, &#39;HISTORY&#39;, line, refkey=href)

    f1 = beta_g / (frmrate * integ * eperadu)
    f2 = ((rn / eperadu) ** 2) / (frmrate * integ)
    return (data * f1) + f2</div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.1.2. &nbsp;
    Last built 13 Aug 2023. <br/>
  </p>
</footer>
  </body>
</html>