<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sofia_redux.instruments.hawc.steps.steprotate &#8212; sofia_redux v1.3.4.dev0</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/plot_directive.css" />
    
    <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js?v=602f4d50"></script>
    <script src="../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script type="text/javascript" src="../../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://www.sofia.usra.edu/"></a></li>
    <li><a title="General Index" href="../../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../../index.html">sofia_redux v1.3.4.dev0</a>
	 &#187;
      </li>
      <li><a href="../../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sofia_redux.instruments.hawc.steps.steprotate</h1><div class="highlight"><pre>
<span></span># Licensed under a 3-clause BSD style license - see LICENSE.rst
&quot;&quot;&quot;Stokes Q and U rotation pipeline step.&quot;&quot;&quot;

from astropy import log
import numpy as np

from sofia_redux.instruments.hawc.stepparent import StepParent

__all__ = [&#39;StepRotate&#39;]


<div class="viewcode-block" id="StepRotate"><a class="viewcode-back" href="../../../../../api/sofia_redux.instruments.hawc.steps.steprotate.StepRotate.html#sofia_redux.instruments.hawc.steps.steprotate.StepRotate">[docs]</a>class StepRotate(StepParent):
    r&quot;&quot;&quot;
    Rotate Stokes Q and U from detector reference frame to sky.

    The rotation angle is derived from telescope data and the
    half-wave plate (HWP) position for the observation.
    The telescope vertical position angle (VPA) is read from the FITS
    header keyword VPOS_ANG.  HWP zero angle and actual initial angle are
    read from the keywords HWPSTART and HWPINIT, respectively.

    Input for this step is a DataFits containing STOKES and ERROR frames
    for I, Q and U each, as well as COVAR Q I, COVAR U I, and COVAR Q U
    extensions. This step is typically run after the
    `sofia_redux.instruments.hawc.steps.StepIP` pipeline step.  The
    output image contains the same image frames as the input image.
    STOKES and ERROR frames for Q and U have been rotated;
    the covariance frames have been propagated.

    Notes
    -----
    The rotation angle is defined per the HAWC+ Geometric
    Reference (Kov√°cs memo, Appendix H), and is applied to the Q and U
    images with a standard rotation matrix as follows:

       .. math:: Q&#39; = cos(\alpha) Q + sin(\alpha) U

       .. math:: U&#39; = sin(\alpha) Q - cos(\alpha) U.

       .. math:: \sigma_Q&#39; = \sqrt{(cos(\alpha)\sigma_Q)^2
                             + (sin(\alpha) \sigma_U)^2
                             +  2 cos(\alpha) sin(\alpha) \sigma_{QU}}

       .. math:: \sigma_U&#39; = \sqrt{(sin(\alpha)\sigma_Q)^2
                             + (cos(\alpha) \sigma_U)^2
                             -  2 cos(\alpha) sin(\alpha) \sigma_{QU}}

       .. math:: \sigma_{Q&#39;I} = cos(\alpha) \sigma_{QI}
                                + sin(\alpha) \sigma_{UI}

       .. math:: \sigma_{U&#39;I} = sin(\alpha) \sigma_{QI}
                                - cos(\alpha) \sigma_{UI}

       .. math:: \sigma_{Q&#39;U&#39;} = cos(\alpha)sin(\alpha)(\sigma_Q^2
                                                        - \sigma_U^2)
                                 + (sin^2(\alpha) - cos^2(\alpha)) \sigma_{QU}.

    &quot;&quot;&quot;
<div class="viewcode-block" id="StepRotate.setup"><a class="viewcode-back" href="../../../../../api/sofia_redux.instruments.hawc.steps.steprotate.StepRotate.html#sofia_redux.instruments.hawc.steps.steprotate.StepRotate.setup">[docs]</a>    def setup(self):
        &quot;&quot;&quot;
        Set parameters and metadata for the pipeline step.

        Output files have PRODTYPE = &#39;rotate&#39;, and are named with
        the step abbreviation &#39;ROT&#39;.

        Parameters defined for this step are:

        gridangle : list of float
            Angle of the grid in degrees (one value for
            each waveband).
        hwpzero_tol : float
            Tolerance for the difference between commanded and
            actual initial HWP angles.
        hwpzero_option : str
            If set to &#39;commanded&#39;, then the HWPSTART keyword will
            be used if the difference between the initial HWP angles
            is &gt; hwpzero_tol.  If set to &#39;actual&#39;, the HWPINIT keyword
            will be used.  Otherwise, an error will be raised.
        &quot;&quot;&quot;
        # Name of the pipeline reduction step
        self.name = &#39;rotate&#39;
        self.description = &#39;Rotate Stokes&#39;

        # Shortcut for pipeline reduction step and identifier for
        # saved file names.
        self.procname = &#39;rot&#39;

        # Clear Parameter list
        self.paramlist = []

        # Append parameters
        self.paramlist.append([&#39;gridangle&#39;, [0.0, 0.0, 0.0, 0.0, 0.0],
                               &#39;Angle of the grid in degrees &#39;
                               &#39;(for each waveband)&#39;])
        self.paramlist.append([&#39;hwpzero_tol&#39;, 3.0,
                               &#39;Tolerance in the difference between &#39;
                               &#39;commanded and actual initial HWP angles&#39;])
        self.paramlist.append([&#39;hwpzero_option&#39;, &#39;commanded&#39;,
                               &#39;Option to use between &quot;commanded&quot; or &#39;
                               &#39;&quot;actual&quot; in case the difference between &#39;
                               &#39;the initial HWP angles is &gt; hwpzero_tol&#39;])</div>

<div class="viewcode-block" id="StepRotate.read_angle"><a class="viewcode-back" href="../../../../../api/sofia_redux.instruments.hawc.steps.steprotate.StepRotate.html#sofia_redux.instruments.hawc.steps.steprotate.StepRotate.read_angle">[docs]</a>    def read_angle(self):
        &quot;&quot;&quot;
        Read a grid angle value from the parameters.

        The parameters are expected to be defined as a list, with
        one entry for each HAWC band.  The correct value for the
        input data is selected from the list.

        Returns
        -------
        float
            The grid angle.
        &quot;&quot;&quot;
        gridang = self.getarg(&#39;gridangle&#39;)

        waveband = self.datain.getheadval(&#39;spectel1&#39;)
        bands = [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;]
        try:
            idx = bands.index(waveband[-1])
        except (ValueError, IndexError):
            # waveband not in list
            msg = &#39;Cannot parse waveband: %s&#39; % waveband
            log.error(msg)
            raise ValueError(msg)
        try:
            gridang = gridang[idx]
        except IndexError:
            msg = &#39;Need grid angle values for all wavebands&#39;
            log.error(msg)
            raise IndexError(msg)

        return gridang</div>

<div class="viewcode-block" id="StepRotate.run"><a class="viewcode-back" href="../../../../../api/sofia_redux.instruments.hawc.steps.steprotate.StepRotate.html#sofia_redux.instruments.hawc.steps.steprotate.StepRotate.run">[docs]</a>    def run(self):
        &quot;&quot;&quot;
        Run the data reduction algorithm.

        Because this step is single-in, single-out (SISO),
        self.datain must be a DataFits object.  The output
        is also a DataFits object, stored in self.dataout.

        The process is:

        1. Compute the rotation angle from VPA, HWP zero, and
           the grid angle.
        2. Rotate Stokes Q and U arrays.
        3. Propagate errors and covariances.
        &quot;&quot;&quot;
        self.dataout = self.datain.copy()
        nhwp = self.dataout.getheadval(&#39;nhwp&#39;)

        if nhwp == 1:
            log.info(&#39;Only 1 HWP, so skipping step %s&#39; % self.name)
        else:
            vpa = self.dataout.getheadval(&#39;VPOS_ANG&#39;)
            gridang = self.read_angle()
            hwpzero_tol = self.getarg(&#39;hwpzero_tol&#39;)
            hwpzero_option = self.getarg(&#39;hwpzero_option&#39;)

            # Test if commanded and actual initial
            # HWP angles are consistent (within tolerance)
            hwpzero = self.dataout.getheadval(&#39;hwpstart&#39;)
            hwpinit = self.dataout.getheadval(&#39;hwpinit&#39;)
            if hwpzero &gt; 180.:
                hwpzero = hwpzero - 360.
            if hwpinit &gt; 180.:
                hwpinit = hwpinit - 360.
            diffhwp = abs(hwpinit - hwpzero)
            if diffhwp &gt; hwpzero_tol:
                if hwpzero_option == &#39;commanded&#39;:
                    log.error(&#39;Initial HWP angle difference is above &#39;
                              &#39;the tolerance. Will use the %s &#39;
                              &#39;value (%s)&#39; % (hwpzero_option, hwpzero))
                elif hwpzero_option == &#39;actual&#39;:
                    log.error(&#39;Initial HWP angle difference is above &#39;
                              &#39;the tolerance. Will use the %s &#39;
                              &#39;value (%s)&#39; % (hwpzero_option, hwpinit))
                    hwpzero = hwpinit
                else:
                    msg = &#39;Initial HWP angle difference is above the &#39; \
                          &#39;tolerance. hwpzero_option parameter value &#39; \
                          &#39;must be commanded or actual&#39;
                    log.error(msg)
                    raise ValueError(msg)

            # The equations below are described at Appendix H of
            # Attila&#39;s memo on &#39;HAWC+ Geometric Reference&#39;

            # propagation equations:
            # I&#39; = I
            # Q&#39; = c Q + s U
            # U&#39; = s Q - c U
            # VI&#39; = VI
            # VQ&#39; = c^2 VQ + s^2 VU + 2 c s cov(Q,U)
            # VU&#39; = s^2 VQ + c^2 VU - 2 c s cov(Q,U)
            # cov(Q&#39;,I&#39;) = c cov(Q,I) + s cov(U,I)
            # cov(U&#39;,I&#39;) = s cov(Q,I) - c cov(U,I)
            # cov(Q&#39;,U&#39;) = c s VQ - c s VU + (s^2 - c^2) cov(Q,U)

            theta = (vpa + 2. * (hwpzero - 5.) + gridang) * np.pi / 180.
            cos = np.cos(2. * theta)
            sin = np.sin(2. * theta)
            oldq = self.dataout.imageget(&#39;STOKES Q&#39;)
            oldu = self.dataout.imageget(&#39;STOKES U&#39;)
            q = cos * oldq + sin * oldu
            self.dataout.imageset(q, &#39;STOKES Q&#39;)
            u = sin * oldq - cos * oldu
            self.dataout.imageset(u, &#39;STOKES U&#39;)

            varq = (self.dataout.imageget(&#39;ERROR Q&#39;))**2
            varu = (self.dataout.imageget(&#39;ERROR U&#39;))**2
            covqi = self.dataout.imageget(&#39;COVAR Q I&#39;)
            covui = self.dataout.imageget(&#39;COVAR U I&#39;)
            covqu = self.dataout.imageget(&#39;COVAR Q U&#39;)

            varqprime = cos**2 * varq + \
                sin**2 * varu + \
                2 * cos * sin * covqu
            varuprime = sin**2 * varq + \
                cos**2 * varu - \
                2 * cos * sin * covqu

            covqiprime = cos * covqi + sin * covui
            covuiprime = sin * covqi - cos * covui
            covquprime = cos * sin * varq - \
                cos * sin * varu + \
                (sin**2 - cos**2) * covqu

            self.dataout.imageset(np.sqrt(varqprime), &#39;ERROR Q&#39;)
            self.dataout.imageset(np.sqrt(varuprime), &#39;ERROR U&#39;)
            self.dataout.imageset(covqiprime, &#39;COVAR Q I&#39;)
            self.dataout.imageset(covuiprime, &#39;COVAR U I&#39;)
            self.dataout.imageset(covquprime, &#39;COVAR Q U&#39;)</div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.1.2. &nbsp;
    Last built 13 Aug 2023. <br/>
  </p>
</footer>
  </body>
</html>