<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sofia_redux.instruments.hawc.steps.stepopacity &#8212; sofia_redux v1.3.4.dev0</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/plot_directive.css" />
    
    <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js?v=602f4d50"></script>
    <script src="../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script type="text/javascript" src="../../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://www.sofia.usra.edu/"></a></li>
    <li><a title="General Index" href="../../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../../index.html">sofia_redux v1.3.4.dev0</a>
	 &#187;
      </li>
      <li><a href="../../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sofia_redux.instruments.hawc.steps.stepopacity</h1><div class="highlight"><pre>
<span></span># Licensed under a 3-clause BSD style license - see LICENSE.rst
&quot;&quot;&quot;Opacity correction pipeline step.&quot;&quot;&quot;

from astropy import log

from sofia_redux.calibration.pipecal_util import \
    apply_tellcor, get_tellcor_factor
from sofia_redux.calibration.pipecal_config import pipecal_config
from sofia_redux.instruments.hawc.stepparent import StepParent

__all__ = [&#39;StepOpacity&#39;]


<div class="viewcode-block" id="StepOpacity"><a class="viewcode-back" href="../../../../../api/sofia_redux.instruments.hawc.steps.stepopacity.StepOpacity.html#sofia_redux.instruments.hawc.steps.stepopacity.StepOpacity">[docs]</a>class StepOpacity(StepParent):
    &quot;&quot;&quot;
    Apply an atmospheric opacity correction.

    This step corrects for atmospheric transmission based on a
    standard model of the atmosphere, the altitude/ZA in the
    header, and the instrument response by band. The correction
    factor is multiplied into the flux images, and propagated
    to the variance and covariance images.

    Opacity correction factors are calculated and applied by
    algorithms in the `sofia_redux.calibration` package:

      - `sofia_redux.calibration.pipecal_config`: `pipecal_config`
      - `sofia_redux.calibration.pipecal_util`:
        `get_tellcor_factor`, `apply_tellcor`

    Input for this image must contain either STOKES and ERROR images,
    as produced by the `sofia_redux.instruments.hawc.steps.StepStokes`
    pipeline step, or else PRIMARY IMAGE and NOISE images, as produced by the
    `sofia_redux.instruments.hawc.steps.StepScanMap` pipeline step. For
    polarimetry data, covariance images (COVAR Q I, COVAR U I, and COVAR Q U)
    are also expected. The output DataFits has the same extensions as the
    input.
    &quot;&quot;&quot;
<div class="viewcode-block" id="StepOpacity.setup"><a class="viewcode-back" href="../../../../../api/sofia_redux.instruments.hawc.steps.stepopacity.StepOpacity.html#sofia_redux.instruments.hawc.steps.stepopacity.StepOpacity.setup">[docs]</a>    def setup(self):
        &quot;&quot;&quot;
        Set parameters and metadata for the pipeline step.

        Output files have PRODTYPE = &#39;calibrate&#39;, and are named with
        the step abbreviation &#39;CAL&#39;.

        No parameters are currently defined for this step.
        &quot;&quot;&quot;
        # Name of the pipeline reduction step
        self.name = &#39;opacity&#39;
        self.description = &#39;Correct Opacity&#39;

        # Shortcut for pipeline reduction step and identifier for
        # saved file names.
        self.procname = &#39;opc&#39;

        # Clear Parameter list
        self.paramlist = []</div>

<div class="viewcode-block" id="StepOpacity.run"><a class="viewcode-back" href="../../../../../api/sofia_redux.instruments.hawc.steps.stepopacity.StepOpacity.html#sofia_redux.instruments.hawc.steps.stepopacity.StepOpacity.run">[docs]</a>    def run(self):
        &quot;&quot;&quot;
        Run the data reduction algorithm.

        Because this step is single-in, single-out (SISO),
        self.datain must be a DataFits object. The output
        is also a DataFits object, stored in self.dataout.

        The process is:

        1. Retrieve an opacity correction factor from the
           `sofia_redux.calibration` package.
        2. Multiply flux and error images by the correction factor.
           Multiply covariance images by the correction factor squared.
        &quot;&quot;&quot;

        # Copy datain to dataout
        self.dataout = self.datain.copy()

        # Get pipecal config
        cal_conf = pipecal_config(self.dataout.header)

        # Assemble extensions to correct
        imgnames = self.dataout.imgnames
        if &#39;PRIMARY IMAGE&#39; in imgnames and &#39;NOISE&#39; in imgnames:
            # for scan products
            extnames = [&#39;PRIMARY IMAGE&#39;, &#39;NOISE&#39;]
        else:
            try:
                nhwp = self.dataout.getheadval(&#39;nhwp&#39;)
            except KeyError:
                nhwp = 1
            if nhwp == 1:
                stokes = [&#39;I&#39;]
            else:
                stokes = [&#39;I&#39;, &#39;Q&#39;, &#39;U&#39;]

            # flux, error
            extnames = []
            for var in stokes:
                extnames.append(&#39;STOKES %s&#39; % var)
                extnames.append(&#39;ERROR %s&#39; % var)

            # stokes covariances
            if nhwp &gt; 1:
                stokes = [&#39;Q I&#39;, &#39;U I&#39;, &#39;Q U&#39;]
                for var in stokes:
                    extnames.append(&#39;COVAR %s&#39; % var)

        # Correct each extension
        header = self.dataout.header
        corrfac = 1.0
        for i, extname in enumerate(extnames):
            log.debug(&#39;Correcting extension: {}&#39;.format(extname))
            data = self.dataout.imageget(extname)

            if i == 0:
                # correct data and write values to primary header
                corrdata = apply_tellcor(data, header, cal_conf)
                corrfac = get_tellcor_factor(header, cal_conf)
                log.info(&#39;Opacity correction factor: &#39;
                         &#39;{:.4f}&#39;.format(corrfac))
            else:
                if &#39;VAR&#39; in extname:
                    corrdata = corrfac ** 2 * data
                else:
                    corrdata = corrfac * data

            self.dataout.imageset(corrdata, extname)</div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.1.2. &nbsp;
    Last built 13 Aug 2023. <br/>
  </p>
</footer>
  </body>
</html>