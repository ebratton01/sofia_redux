<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sofia_redux.visualization.models.model &#8212; sofia_redux v1.3.4.dev0</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    
    <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js?v=602f4d50"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://www.sofia.usra.edu/"></a></li>
    <li><a title="General Index" href="../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../index.html">sofia_redux v1.3.4.dev0</a>
	 &#187;
      </li>
      <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sofia_redux.visualization.models.model</h1><div class="highlight"><pre>
<span></span># Licensed under a 3-clause BSD style license - see LICENSE.rst

import os.path
import re
import astropy.io.fits as pf
from typing import Optional
import numpy as np
import pandas as pd

from sofia_redux.visualization import log
from sofia_redux.visualization.models import high_model

__all__ = [&#39;Model&#39;, &#39;parse_general&#39;]


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../../../api/sofia_redux.visualization.models.model.Model.html#sofia_redux.visualization.models.model.Model">[docs]</a>class Model(object):
    &quot;&quot;&quot;
    The starting point for Eye of SOFIA models.

    Data read in from FITS or non-fits files are stored in a collection
    of model object in this directory. The structure of a single
    complete FITS file is as follows:

    - High-Level Model
       - High-level models hold the contents of an entire FITS file.
         All interfaces should interact with the high level
         model, which controls and manages the lower level models.
       - Available models are:
           - Grism : for files with multiple images and a single spectrum.
           - MultiOrder: for files with multiple images and multiple spectra.

    - Mid-Level Models
       - Mid-level models hold all data structures that would need to
         be included together to be considered valid.
       - Available models are:
           - Book: For holding multiple images of the same target.
           - Order: For holding multiple spectra of the same target.

    - Low-Level Models
       - Low-level models hold the simplest data sets. For example, a
         single `Order` is made of multiple `Spectrum` objects, one for the
         wavelength data, one for the flux data, one for the error data, etc.
         All operations are performed at this level, such as unit conversions,
         but only by interacting through the higher-level models. The user
         should not interact with low level models directly.
       - Available models are:
           - Image: For holding a single 2d data set.
           - Spectrum: For holding a single 1d data set.

    This module contains the interface controlling the initialization
    of a high level model. Once the high level model is created, the viewer
    operates on that object. The `Model` object here is not to be instantiated;
    it is merely used to implement the `add_model` method.
    &quot;&quot;&quot;

<div class="viewcode-block" id="Model.add_model"><a class="viewcode-back" href="../../../../api/sofia_redux.visualization.models.model.Model.html#sofia_redux.visualization.models.model.Model.add_model">[docs]</a>    @staticmethod
    def add_model(filename: str = &#39;&#39;,
                  hdul: Optional[pf.HDUList] = None) -&gt; high_model.HighModel:
        &quot;&quot;&quot;
        Parse a FITS file into the appropriate high level model.

        Either `filename` or `hdul` must be specified.

        Parameters
        ----------
        filename : str, optional
            Absolute path to the FITS file to read and parse.
        hdul : `astropy.io.fits.HDUList`, optional
            An astropy HDUList to parse.

        Returns
        -------
        model : model.high_model.HighModel
            The high level model populated with the
            contents of `filename`.

        Raises
        ------
        NotImplementedError
            If the current instrument/data type is not supported.
        RuntimeError
            If invalid arguments are passed.
        &quot;&quot;&quot;
        if filename and hdul is not None:
            raise RuntimeError(&#39;Model.add_model can only accept `filename` &#39;
                               &#39;or `hdul`, not both&#39;)
        if hdul is None:
            if filename:
                if &#39;fits&#39; not in filename:
                    hdul = parse_general(filename)
                else:
                    hdul = pf.open(filename, memmap=False)
            else:
                raise RuntimeError(&#39;Need to provide an hdul or filename.&#39;)

        header = hdul[0].header

        instrument = str(header.get(&#39;INSTRUME&#39;)).lower()

        if instrument in [&#39;forcast&#39;, &#39;flitecam&#39;]:
            model = high_model.Grism(hdul)
            if model.num_orders == 0:
                raise NotImplementedError(&#39;Image display is not supported.&#39;)
        elif instrument == &#39;general&#39;:
            model = high_model.MultiOrder(hdul, general=True)
        elif instrument == &#39;exes&#39;:
            model = high_model.MultiOrder(hdul)
        elif instrument == &#39;none&#39; or instrument == &#39;&#39;:
            # Assign the instrument to &#39;General&#39; when no instrument
            # information has been provided.
            hdul[0].header[&#39;instrume&#39;] = &#39;General&#39;
            hdul[0].header[&#39;prodtype&#39;] = &#39;General&#39;
            if not header.get(&#39;XUNIT&#39;) and not header.get(&#39;XUNITS&#39;):
                hdul[0].header[&#39;XUNITS&#39;] = &#39;um&#39;
            if not header.get(&#39;YUNIT&#39;) and not header.get(&#39;YUNITS&#39;):
                hdul[0].header[&#39;YUNITS&#39;] = &#39;Jy&#39;
            model = high_model.MultiOrder(hdul, general=True)
        else:
            raise NotImplementedError(&#39;Instrument is not supported&#39;)

        # if true filename was supplied, store it in the model
        if filename:
            model.filename = filename

        log.debug(f&#39;Created model with id: {model.id}&#39;)
        hdul.close()
        return model</div></div>


<div class="viewcode-block" id="parse_general"><a class="viewcode-back" href="../../../../api/sofia_redux.visualization.models.model.parse_general.html#sofia_redux.visualization.models.model.parse_general">[docs]</a>def parse_general(filename: str) -&gt; pf.HDUList:
    &quot;&quot;&quot;
    Parse a text-based data file.

    Data is converted into a FITS-style HDUList for further handling.

    Based on the number of columns in this dataset, it is parsed
    accordingly. If column labels have been provided, it uses them,
    otherwise, it assumes a general order of [wavelength, flux, error,
    transmission, response] for the columns.

    Parameters
    ----------
    filename : str
        Absolute path to the non-FITS file to read and parse.

    Returns
    -------
    hdul_read : &#39;astropy.io.fits.HDUList&#39;
        An astropy HDUList

    Raises
    ------
    RuntimeError
        If invalid file is passed or invalid columns in the file.
    &quot;&quot;&quot;

    header = pf.Header()
    header[&#39;XUNITS&#39;] = &#39;um&#39;
    header[&#39;YUNITS&#39;] = &#39;Jy&#39;
    header[&#39;INSTRUME&#39;] = &#39;General&#39;
    header[&#39;PRODTYPE&#39;] = &#39;General&#39;
    header[&#39;FILENAME&#39;] = os.path.basename(filename)

    # determining the delimiter in the file
    with open(filename, &#39;r&#39;) as f:
        skip_rows = 0
        names = list()
        for line in f:
            if _is_number(line.strip()):
                break
            else:
                names = line.replace(&#39;#&#39;, &#39;&#39;).strip()
                names = re.sub(&#39; +&#39;, &#39; &#39;, names)
                delimiter = re.findall(r&#39;[,|]|\s,&#39;, names)
                if delimiter:
                    delimiter = delimiter[0]
                else:
                    delimiter = &#39; &#39;
                names = names.split(delimiter)
                skip_rows += 1
                break
    f.close()

    # Attempting to read the file using pandas
    try:
        data = pd.read_csv(filename, sep=r&#39;\,|\t+|\s+&#39;, skiprows=skip_rows,
                           names=names, engine=&#39;python&#39;)
    except pd.errors.ParserError:
        raise RuntimeError(&#39;Could not parse text file&#39;) from None

    try:
        n_columns = data.shape[1]
    except IndexError:  # pragma: no cover
        n_columns = 1

    # Data with single column is assumed to be flux and
    # is plotted against pixels.

    if n_columns == 1:
        # assuming its flux
        wavelength = np.arange(data.shape[0])
        data.insert(0, &quot;wavepos[pixel]&quot;, wavelength)

    cols = data.columns
    if not str(cols[1]).isdigit():
        data_new, col_wave, col_flux, col_error, col_trans, col_response = \
            None, None, None, None, None, None
        try:
            if n_columns &gt;= 2:
                col_flux = cols[cols.str.contains(&#39;flux&#39;, flags=re.I)]
                col_wave = cols[cols.str.contains(&#39;wave&#39;, flags=re.I)]
                data_new = data.loc[:, [col_wave[0], col_flux[0]]]

            if n_columns &gt;= 3:
                col_error = cols[cols.str.contains(&#39;err&#39;, flags=re.I,
                                                   regex=False)]
                data_new = data.loc[:, [col_wave[0], col_flux[0],
                                        col_error[0]]]

            if n_columns &gt;= 4:
                col_trans = cols[cols.str.contains(&#39;tran&#39;, flags=re.I,
                                                   regex=False)]
                data_new = data.loc[:, [col_wave[0], col_flux[0], col_error[0],
                                        col_trans[0]]]

            if n_columns &gt;= 5:
                col_response = cols[cols.str.contains(&#39;response&#39;, flags=re.I,
                                                      regex=False)]
                data_new = data.loc[:, [col_wave[0], col_flux[0], col_error[0],
                                        col_trans[0], col_response[0]]]

        except (IndexError, ValueError, TypeError):
            raise RuntimeError(&#39;Unexpected columns in text file&#39;) from None

        if data_new is not None:
            data = data_new
            cols = data.columns

    # Parsing units
    if &#39;[&#39; in str(cols[0]):
        header[&#39;XUNITS&#39;] = cols[0][cols[0].find(&#39;[&#39;) + 1:cols[
            0].find(&#39;]&#39;)]
    elif &#39;(&#39; in str(cols[0]):
        header[&#39;XUNITS&#39;] = cols[0][cols[0].find(&#39;(&#39;) + 1:cols[
            0].find(&#39;)&#39;)]

    if &#39;[&#39; in str(cols[1]):
        header[&#39;YUNITS&#39;] = cols[1][cols[1].find(&#39;[&#39;) + 1:cols[
            1].find(&#39;]&#39;)]
    elif &#39;(&#39; in str(cols[1]):
        header[&#39;YUNITS&#39;] = cols[1][cols[1].find(&#39;(&#39;) + 1:cols[
            1].find(&#39;)&#39;)]

    header[&#39;NAXIS1&#39;] = data.shape[0]
    header[&#39;NAXIS2&#39;] = data.shape[1]
    header[&#39;NAPS&#39;] = 1
    header[&#39;NORDERS&#39;] = 1

    hdu_read = pf.PrimaryHDU(data.T, header)

    # Converting it to hdul
    hdul_read = pf.HDUList(hdu_read)
    return hdul_read</div>


def _is_number(s) -&gt; bool:
    &quot;&quot;&quot;
    Determines if a string is a number or not.

    Returns
    -------
    bool
        True if input can be converted to float; False otherwise
    &quot;&quot;&quot;
    try:
        float(s)
    except ValueError:
        return False
    else:
        return True
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.1.2. &nbsp;
    Last built 13 Aug 2023. <br/>
  </p>
</footer>
  </body>
</html>