<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sofia_redux.calibration.standard_model.hawc_calibration &#8212; sofia_redux v1.3.4.dev0</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    
    <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js?v=602f4d50"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://www.sofia.usra.edu/"></a></li>
    <li><a title="General Index" href="../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../index.html">sofia_redux v1.3.4.dev0</a>
	 &#187;
      </li>
      <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sofia_redux.calibration.standard_model.hawc_calibration</h1><div class="highlight"><pre>
<span></span># Licensed under a 3-clause BSD style license - see LICENSE.rst
&quot;&quot;&quot;Generates models of calibration objects for HAWC+ observations&quot;&quot;&quot;

import datetime as dt
import argparse
import sys
import os
import pandas as pd

from sofia_redux.calibration.standard_model \
    import horizons, genastmodel2, hawc_calib, modconvert
from sofia_redux.calibration.pipecal_error import PipeCalError


<div class="viewcode-block" id="calibration_data_path"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.calibration_data_path.html#sofia_redux.calibration.standard_model.hawc_calibration.calibration_data_path">[docs]</a>def calibration_data_path():
    &quot;&quot;&quot;
    Determine the location of calibration data.

    Returns
    -------
    caldata : str
        Absolute path of the calibration directory.

    &quot;&quot;&quot;
    # get the calibration data path
    pkgpath = (os.path.dirname(
        os.path.dirname(os.path.realpath(__file__))) + os.path.sep)
    caldata = os.path.join(*[pkgpath, &#39;data&#39;, &#39;models&#39;])
    return caldata</div>


<div class="viewcode-block" id="model_dist"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.model_dist.html#sofia_redux.calibration.standard_model.hawc_calibration.model_dist">[docs]</a>def model_dist(target, caldata):
    &quot;&quot;&quot;
    Determine the distance to a target in a Herschel model.

    Parses the herschel readme to get the distance of
    the object used in the Herschel model.

    Parameters
    ----------
    target : str
        Name of the target.
    caldata : str
        Path to the calibration data.

    Returns
    -------
    d_model : float
        Distance to the target in AU.

    &quot;&quot;&quot;
    # Get the distance of the model:
    d_model = None
    herschel_parameters = os.path.join(caldata, &#39;readme.txt&#39;)
    with open(herschel_parameters) as f:
        for line in f:
            if line.lower().startswith(target.lower()):
                d_model = float(line.split()[3])
                d_model *= 6.68459e-9
    if not d_model:
        raise PipeCalError(f&#39;Unable to find major target {target} in &#39;
                           f&#39;{herschel_parameters}&#39;)
    return d_model</div>


<div class="viewcode-block" id="generate_major_outfile"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.generate_major_outfile.html#sofia_redux.calibration.standard_model.hawc_calibration.generate_major_outfile">[docs]</a>def generate_major_outfile(target, herschel_file, date):
    &quot;&quot;&quot;
    Generate the name of the output file for major targets.

    Parameters
    ----------
    target : str
        Name of the target.
    herschel_file : str
        Name of the Herschel file for `target`.
    date : str
        Date of the observation.

    Returns
    -------
    model_outfile : str
        Name of output file to write to.

    &quot;&quot;&quot;
    esa = os.path.basename(herschel_file).split(&#39;_&#39;)[1].upper()
    date_clean = dt.datetime.strptime(date, &#39;%Y-%m-%d&#39;).strftime(&#39;%Y%b%d&#39;)
    model_outfile = f&#39;{target.capitalize()}_{date_clean}_{esa}.txt&#39;
    return model_outfile</div>


<div class="viewcode-block" id="apply_scale_factor"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.apply_scale_factor.html#sofia_redux.calibration.standard_model.hawc_calibration.apply_scale_factor">[docs]</a>def apply_scale_factor(herschel_file, outfile, fscale):
    &quot;&quot;&quot;
    Apply a scale factor to Herschel model to account for distance.

    Parameters
    ----------
    herschel_file : str
        Name of file containing Herschel model.
    outfile : str
        Name of file to write scaled model to.
    fscale : float
        Scale to apply.

    Returns
    -------
    model : pandas.DataFrame
        Scaled Herschel model.

    &quot;&quot;&quot;
    model = modconvert.modconvert(herschel_file, outfile, fscale)
    return model</div>


<div class="viewcode-block" id="scale_factor"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.scale_factor.html#sofia_redux.calibration.standard_model.hawc_calibration.scale_factor">[docs]</a>def scale_factor(distance, params):
    &quot;&quot;&quot;
    Determine the scale factor for accounting for distance to target.

    Parameters
    ----------
    distance : float
        Distance to the target in AU.
    params : dict
        Parameters describing the Herschel model.

    Returns
    -------
    fscale : float
        Scale factor to apply to model flux.

    &quot;&quot;&quot;
    fscale = (distance / params[&#39;delta&#39;]) ** 2
    return fscale</div>


<div class="viewcode-block" id="classify_target"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.classify_target.html#sofia_redux.calibration.standard_model.hawc_calibration.classify_target">[docs]</a>def classify_target(target):
    &quot;&quot;&quot;
    Determine if a target is a minor or major target.

    Parameters
    ----------
    target : str
        Target name.

    Returns
    -------
    classification : str
        Set to &#39;major&#39; if target is Uranus, Neptune, Ganymede, or
        Callisto. Set to &#39;minor&#39; otherwise.

    &quot;&quot;&quot;

    major_targets = [&#39;uranus&#39;, &#39;neptune&#39;, &#39;ganymede&#39;, &#39;callisto&#39;]
    if target.lower() in major_targets:
        return &#39;major&#39;
    else:
        return &#39;minor&#39;</div>


<div class="viewcode-block" id="read_obstimes"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.read_obstimes.html#sofia_redux.calibration.standard_model.hawc_calibration.read_obstimes">[docs]</a>def read_obstimes(obs_files):
    &quot;&quot;&quot;
    Read in when the observations took place.

    Parameters
    ----------
    obs_files : str
        Name of the file containing the description of the
        observations.

    Returns
    -------
    obs_times : pandas.DataFrame
        Details of the observations.

    Raises
    ------
    PipeCalError
        If any part of `obs_files` is imporoperly formatted.

    &quot;&quot;&quot;
    try:
        obs_times = pd.read_csv(obs_files, names=[&#39;date&#39;, &#39;time&#39;, &#39;target&#39;],
                                sep=r&#39;\s+&#39;)
    except IOError:
        raise PipeCalError(f&#39;Unable to read obs_times file {obs_files}&#39;)
    if obs_times.isna().sum().sum() &gt; 0:
        raise PipeCalError(f&#39;Obs_times file {obs_files} is improperly &#39;
                           f&#39;formatted.&#39;)
    obs_times[&#39;datetime&#39;] = obs_times[&#39;date&#39;] + &#39;T&#39; + obs_times[&#39;time&#39;]
    try:
        obs_times[&#39;datetime&#39;] = pd.to_datetime(obs_times[&#39;datetime&#39;])
    except (SyntaxError, ValueError):
        raise PipeCalError(f&#39;Obs_times file {obs_files} has improperly &#39;
                           f&#39;formatted dates/times.&#39;)

    return obs_times</div>


<div class="viewcode-block" id="select_herschel_file"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.select_herschel_file.html#sofia_redux.calibration.standard_model.hawc_calibration.select_herschel_file">[docs]</a>def select_herschel_file(target):
    &quot;&quot;&quot;
    Determine the correct Herschel model to use for the target.

    Parameters
    ----------
    target : str
        Name of target.

    Returns
    -------
    herschel_model : str
        Absolute path to the file containing the correct
        Herschel model.

    &quot;&quot;&quot;
    caldata = calibration_data_path()
    herschel_files = {&#39;uranus&#39;: &#39;ura_esa2_2_i.dat&#39;,
                      &#39;neptune&#39;: &#39;nep_esa5_2_i.dat&#39;,
                      &#39;ganymede&#39;: &#39;gany_esa2_2_i.dat&#39;,
                      &#39;callisto&#39;: &#39;call_esa2_2_i.dat&#39;}
    herschel_model = os.path.join(caldata, herschel_files[target.lower()])
    return herschel_model</div>


<div class="viewcode-block" id="parse_atran_filename"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.parse_atran_filename.html#sofia_redux.calibration.standard_model.hawc_calibration.parse_atran_filename">[docs]</a>def parse_atran_filename(atran):
    &quot;&quot;&quot;
    Pull the alittude and zenith angle from the ATRAN filename.

    Parameters
    ----------
    atran : str
        Name of the ATRAN file.

    Returns
    -------
    altitude : str
        Altitude of the plane for the atmospheric model.
    zenith : str
        Zenith angle for the atmospheric model.

    &quot;&quot;&quot;
    altitude = os.path.basename(atran).split(&#39;_&#39;)[1]
    zenith = os.path.basename(atran).split(&#39;_&#39;)[2]
    return altitude, zenith</div>


<div class="viewcode-block" id="generate_major_cal_outfile"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.generate_major_cal_outfile.html#sofia_redux.calibration.standard_model.hawc_calibration.generate_major_cal_outfile">[docs]</a>def generate_major_cal_outfile(row, atran, herschel_file):
    &quot;&quot;&quot;
    Generate the name of the output file for a major target.

    Parameters
    ----------
    row : pandas.Series
        Details of a single observation.
    atran : str
        Name of the ATRAN file used.
    herschel_file : str
        Name of the standard Herschel file for
        this target.

    Returns
    -------
    calib_outfile : str
        Name of the calibration outfile to write the model to.

    &quot;&quot;&quot;
    date = row[&#39;date&#39;]
    if isinstance(date, str):
        date = dt.datetime.strptime(date, &#39;%Y-%m-%d&#39;)
    date_clean = date.strftime(&#39;%Y%b%d&#39;)
    esa = os.path.basename(herschel_file).split(&#39;_&#39;)[1].upper()
    altitude, zenith = parse_atran_filename(atran)
    calib_outfile = (f&#39;HAWC_&#39;
                     f&#39;{row[&quot;target&quot;].capitalize()}_{esa}_&#39;
                     f&#39;{date_clean}_{altitude}_&#39;
                     f&#39;{zenith}.out&#39;)
    return calib_outfile</div>


<div class="viewcode-block" id="model_minor_body"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.model_minor_body.html#sofia_redux.calibration.standard_model.hawc_calibration.model_minor_body">[docs]</a>def model_minor_body(obs_times, atran):
    &quot;&quot;&quot;
    Generate a model for a minor target.

    Parameters
    ----------
    obs_times : pandas.DataFrame
        Inforamtion describing all observations of the target.
    atran : str
        Name of ATRAN file to use for atmospheric modeling.

    Returns
    -------
    obs : pandas.DataFrame
        Copy of `obs_times` with added columns describing the
        name of the model and calibration files.

    &quot;&quot;&quot;
    rows = []
    for index, row in obs_times.iterrows():
        params = horizons.asteroid_query(
            target=row[&#39;target&#39;], date=row[&#39;date&#39;], time=row[&#39;time&#39;])
        model_outfile = generate_minor_outfile(row)
        calibration_outfile = generate_minor_cal_outfile(row, atran)
        genastmodel2.asteroid_model(params=params, date=row[&#39;date&#39;],
                                    time=row[&#39;time&#39;], outfile=model_outfile)
        row[&#39;model_file&#39;] = model_outfile
        row[&#39;cal_file&#39;] = calibration_outfile
        rows.append(row)
    return pd.DataFrame(rows)</div>


<div class="viewcode-block" id="generate_minor_outfile"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.generate_minor_outfile.html#sofia_redux.calibration.standard_model.hawc_calibration.generate_minor_outfile">[docs]</a>def generate_minor_outfile(row):
    &quot;&quot;&quot;
    Generate the name of the output file for a minor target.

    Parameters
    ----------
    row : pandas.Series
        Details of a single observation.

    Returns
    -------
    outfile : str
        Name of the outfile to write the model to.

    &quot;&quot;&quot;
    target = row[&#39;target&#39;]
    date = row[&#39;date&#39;]
    time = row[&#39;time&#39;]
    outfile = f&#39;{target.capitalize()}_{date}_{time}_model.out&#39;
    outfile = outfile.replace(&#39;:&#39;, &#39;&#39;)
    return outfile</div>


<div class="viewcode-block" id="generate_minor_cal_outfile"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.generate_minor_cal_outfile.html#sofia_redux.calibration.standard_model.hawc_calibration.generate_minor_cal_outfile">[docs]</a>def generate_minor_cal_outfile(row, atran):
    &quot;&quot;&quot;
    Generate the name of the output file for a minor target.

    Parameters
    ----------
    row : pandas.Series
        Details of a single observation.
    atran : str
        Name of ATRAN file used for atmosphere modeling.

    Returns
    -------
    calib_outfile : str
        Name of the calibration outfile to write the model to.

    &quot;&quot;&quot;
    date = row[&#39;date&#39;]
    if isinstance(date, str):
        date = dt.datetime.strptime(date, &#39;%Y-%m-%d&#39;)
    date_clean = date.strftime(&#39;%Y%b%d&#39;)
    target = row[&#39;target&#39;].capitalize()
    altitude, zenith = parse_atran_filename(atran)
    calib_outfile = (f&#39;HAWC_{target.capitalize()}_{date_clean}_{altitude}_&#39;
                     f&#39;{zenith}.out&#39;)
    return calib_outfile</div>


<div class="viewcode-block" id="model_major_body"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.model_major_body.html#sofia_redux.calibration.standard_model.hawc_calibration.model_major_body">[docs]</a>def model_major_body(obs_times, caldata, atran):
    &quot;&quot;&quot;
    Generate a model for a major target.

    Parameters
    ----------
    obs_times : pandas.DataFrame
        Information describing all observations of the target.
    caldata : str
        Path to the calibration data.
    atran : str
        Name of ATRAN file to use for atmospheric modeling.

    Returns
    -------
    obs : pandas.DataFrame
        Copy of `obs_times` with added columns describing the
        name of the model and calibration files.

    &quot;&quot;&quot;
    rows = []
    for index, row in obs_times.iterrows():
        herschel_file = select_herschel_file(row[&#39;target&#39;])
        model_outfile = \
            generate_major_outfile(row[&#39;target&#39;], herschel_file, row[&#39;date&#39;])
        calibration_outfile = \
            generate_major_cal_outfile(row, atran, herschel_file)
        params = horizons.simple_query(row[&#39;target&#39;], row[&#39;date&#39;], row[&#39;time&#39;])
        distance = model_dist(row[&#39;target&#39;], caldata)
        fscale = scale_factor(distance, params)
        apply_scale_factor(herschel_file, model_outfile, fscale)
        row[&#39;model_file&#39;] = model_outfile
        row[&#39;cal_file&#39;] = calibration_outfile
        rows.append(row)
    return pd.DataFrame(rows)</div>


<div class="viewcode-block" id="calibration"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.calibration.html#sofia_redux.calibration.standard_model.hawc_calibration.calibration">[docs]</a>def calibration(obs_file, atran):
    &quot;&quot;&quot;
    Generate models of the observed flux from a target.

    Parameters
    ----------
    obs_file : str
        File containing information about all observations.
    atran : str
        Name of the ATRAN file to use for modeling
        atmospheric transmission.

    Returns
    -------
    None

    &quot;&quot;&quot;

    obs_times = read_obstimes(obs_file)

    caldata = calibration_data_path()

    target_type = classify_target(obs_times[&#39;target&#39;][0])

    if target_type == &#39;major&#39;:
        obs_times = model_major_body(obs_times, caldata, atran)
    else:
        obs_times = model_minor_body(obs_times, atran)
    hawc_calib.hawc_calib(obs_times, atran, emiss=0.15, dataframe=True)</div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.main.html#sofia_redux.calibration.standard_model.hawc_calibration.main">[docs]</a>def main(args=None):
    &quot;&quot;&quot;
    Entry point for calibration routines.

    Parameters
    ----------
    args : list, optional
        Any arguments passed in to configure the run.
        If not provided arguements are pulled from
        the command line.

    Returns
    -------
    None

    &quot;&quot;&quot;
    if args is None:  # pragma: no cover
        args = sys.argv[1:]
    args = parse_args(args)
    args = check_args(args)
    print(f&#39;Obs file: {args.obs_file}&#39;)
    print(f&#39;ATRAN: {args.atran}&#39;)
    calibration(args.obs_file, args.atran)</div>


<div class="viewcode-block" id="parse_args"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.parse_args.html#sofia_redux.calibration.standard_model.hawc_calibration.parse_args">[docs]</a>def parse_args(args):
    &quot;&quot;&quot;
    Parse the arguments for configuring calibrations.

    Parameters
    ----------
    args : list
        List of arguments passed in to `main`.

    Returns
    -------
    args : argparse.Namespace
        Arguemnts parsed into an object.

    &quot;&quot;&quot;
    parser = argparse.ArgumentParser(description=&#39;Check FITS headers&#39;)
    parser.add_argument(&#39;obs_file&#39;, metavar=&#39;obs_file&#39;, type=str, nargs=1,
                        help=&#39;file containing dates and times&#39;)
    parser.add_argument(&#39;-a&#39;, &#39;--atran&#39;, dest=&#39;atran&#39;, type=str,
                        action=&#39;store&#39;, default=None,
                        help=&#39;name of ATRAN file&#39;)
    args = parser.parse_args(args)
    return args</div>


<div class="viewcode-block" id="check_args"><a class="viewcode-back" href="../../../../api/sofia_redux.calibration.standard_model.hawc_calibration.check_args.html#sofia_redux.calibration.standard_model.hawc_calibration.check_args">[docs]</a>def check_args(args):
    &quot;&quot;&quot;
    Verify calibration configuration is valid.

    Parameters
    ----------
    args : argparse.Namespace
        Parsed arguments to configure the run.

    Returns
    -------
    args : argparse.Namespace
        Same as input `args` but with all arguments checked.

    &quot;&quot;&quot;
    if args.atran is None:
        args.atran = &#39;atran_41K_45deg_40-300mum.fits&#39;
    if isinstance(args.obs_file, list):
        args.obs_file = args.obs_file[0]
    return args</div>


if __name__ == &#39;__main__&#39;:  # pragma: no cover
    args = parse_args(sys.argv[1:])
    main(args)
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.1.2. &nbsp;
    Last built 13 Aug 2023. <br/>
  </p>
</footer>
  </body>
</html>