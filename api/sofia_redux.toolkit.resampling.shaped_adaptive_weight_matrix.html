<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>shaped_adaptive_weight_matrix &#8212; sofia_redux v1.3.4.dev0</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    
    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=602f4d50"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    <link rel="icon" href="../_static/redux.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="sigmoid" href="sofia_redux.toolkit.resampling.sigmoid.html" />
    <link rel="prev" title="shaped_adaptive_weight_matrices" href="sofia_redux.toolkit.resampling.shaped_adaptive_weight_matrices.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://www.sofia.usra.edu/"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="sofia_redux.toolkit.resampling.sigmoid.html" title="sigmoid">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="sofia_redux.toolkit.resampling.shaped_adaptive_weight_matrices.html" title="shaped_adaptive_weight_matrices">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../index.html">sofia_redux v1.3.4.dev0</a>
	 &#187;
      </li>
      <li><a href="../sofia_redux/index.html" >SOFIA Redux</a> &#187;</li>
      <li><a href="../manuals/fifils/developers/developers.html" accesskey="U">FIFI-LS Redux Developer’s Manual</a> &#187;</li>
      
      <li>shaped_adaptive_weight_matrix</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="shaped-adaptive-weight-matrix">
<h1>shaped_adaptive_weight_matrix<a class="headerlink" href="#shaped-adaptive-weight-matrix" title="Permalink to this heading">¶</a></h1>
<dl class="py function">
<dt class="sig sig-object py" id="sofia_redux.toolkit.resampling.shaped_adaptive_weight_matrix">
<span class="sig-prename descclassname"><span class="pre">sofia_redux.toolkit.resampling.</span></span><span class="sig-name descname"><span class="pre">shaped_adaptive_weight_matrix</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">sigma</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rchi2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">gradient_mscp</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">density</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">variance_offset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fixed</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tolerance</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/sofia_redux/toolkit/resampling/resample_utils.html#shaped_adaptive_weight_matrix"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#sofia_redux.toolkit.resampling.shaped_adaptive_weight_matrix" title="Permalink to this definition">¶</a></dt>
<dd><p>Shape and scale the weighting kernel based on a prior fit.</p>
<p>In the standard resampling algorithm, a polynomial fit may weight each
sample coordinate (<span class="math notranslate nohighlight">\(x\)</span>) according to its distance from the reference
position at which the fit is derived (<span class="math notranslate nohighlight">\(x_{ref}\)</span>) such that samples
closer to the reference position have more influence on the fit than those
that are farther.  The weighting function used is:</p>
<div class="math notranslate nohighlight">
\[W = exp(-\Delta x^T A^{-1} \Delta x)\]</div>
<p>where <span class="math notranslate nohighlight">\({\Delta x}_k = x_{ref, k} - x_k\)</span> for dimension <span class="math notranslate nohighlight">\(k\)</span>, and
<span class="math notranslate nohighlight">\(A\)</span> is a symmetric positive definite matrix defining the “shape” of
the weighting kernel.  This effectively defines a multivariate Gaussian
centered on the reference point where overall size, rotation, and stretch
of each principle axis may be altered.  The goal of shaping the weighting
kernel <span class="math notranslate nohighlight">\(A\)</span>, is to produce a fit where the reduced chi-squared
statistic of the fit equal to one (<span class="math notranslate nohighlight">\(\chi_r^2 = 1\)</span>).  To derive the
shape <span class="math notranslate nohighlight">\(A\)</span>, an initial fit must have first been performed using a
square diagonal matrix <span class="math notranslate nohighlight">\(A_0\)</span>, whose diagonal elements are the square
of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">sigma</span></code> parameter (<span class="math notranslate nohighlight">\(diag(A_0) = 2 \sigma^2\)</span>).  It is then easy
to define <span class="math notranslate nohighlight">\(A_0^{-1}\)</span> in <span class="math notranslate nohighlight">\(K\)</span> dimensions as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}A_0^{-1} = \frac{1}{2}
    \begin{bmatrix}
        \frac{1}{\sigma_0^2} &amp; 0 &amp; \dots &amp; 0 \\
        0 &amp; \frac{1}{\sigma_1^2} &amp; \ddots &amp; \vdots \\
        \vdots &amp; \ddots &amp; \ddots &amp; 0 \\
        0 &amp; \dots &amp; 0 &amp; \frac{1}{\sigma_K^2}
    \end{bmatrix}\end{split}\]</div>
<p>Following (or during) the initial fit with <span class="math notranslate nohighlight">\(A_0\)</span>, the mean
square cross products of the derivatives evaluated at the sample
coordinates should be calculated using <a class="reference internal" href="sofia_redux.toolkit.resampling.derivative_mscp.html#sofia_redux.toolkit.resampling.derivative_mscp" title="sofia_redux.toolkit.resampling.derivative_mscp"><code class="xref py py-func docutils literal notranslate"><span class="pre">derivative_mscp()</span></code></a>, where the
returned matrix has values:</p>
<div class="math notranslate nohighlight">
\[\bar{g}_{ij}^2 = \frac{\partial \bar{f}}{\partial X_i}
                 \frac{\partial \bar{f}}{\partial X_j}\]</div>
<p>for dimensions <span class="math notranslate nohighlight">\(X_i\)</span> and <span class="math notranslate nohighlight">\(X_j\)</span> in K-dimensions, where
<span class="math notranslate nohighlight">\(\partial \bar{f} / \partial X_i\)</span> is the weighted mean of the partial
derivatives over all samples in the fit with respect to <span class="math notranslate nohighlight">\(X_i\)</span>, with
weighting defined by <span class="math notranslate nohighlight">\(W\)</span> (above) using <span class="math notranslate nohighlight">\(A_0^{-1}\)</span>.</p>
<p>The matrix <span class="math notranslate nohighlight">\(\bar{g}^2\)</span> is only used to define the shape of new
weighting kernel, not the overall size.  Therefore, it is normalized such
that <span class="math notranslate nohighlight">\(|\bar{g}^2| = 1\)</span>.</p>
<p>We can then use singular value decomposition to factorize <span class="math notranslate nohighlight">\(\bar{g}^2\)</span>
into:</p>
<div class="math notranslate nohighlight">
\[\bar{g}^2 = U S V^T\]</div>
<p>Here, the matrices <span class="math notranslate nohighlight">\(U\)</span> and <span class="math notranslate nohighlight">\(V^T\)</span> represent rotations (since
<span class="math notranslate nohighlight">\(|\bar{g}^2| &gt; 0\)</span>), and the singular values (<span class="math notranslate nohighlight">\(S\)</span>) can be
thought of as the magnitudes of the semi-axes of an ellipsoid in
K-dimensional space.  Naively, this provides us with a basis from which to
determine the final “shape” matrix where:</p>
<div class="math notranslate nohighlight">
\[A^{-1} = \beta\, \bar{g}^2\]</div>
<p>and <span class="math notranslate nohighlight">\(\beta\)</span> is an as yet undetermined scaling factor representing
the overall size of the new kernel.  The resulting weighting kernel has the
shape of an ellipsoid with the smallest semi-axis oriented parallel to
the gradient.  In other words, the new weighting will result in a fit that
is less sensitive to distant samples in directions where the gradient is
high, and more sensitive to distant samples in directions where the
gradient is low.</p>
<p>However, we must still keep in mind that our overall goal is to get
<span class="math notranslate nohighlight">\(\chi_r^2 \rightarrow 1\)</span> when a fit is performed using the new
kernel <span class="math notranslate nohighlight">\(A\)</span>.  For example, if <span class="math notranslate nohighlight">\(\chi_r=1\)</span> in the initial fit,
there is no need to modify the kernel, and if <span class="math notranslate nohighlight">\(\chi_r &lt; 1\)</span>, then we
do not want to get an even better fit.</p>
<p>Another factor to consider is that we cannot be completely confident in
this new shape due to the distribution of samples.  If we are fitting at a
point that is away from the center of the sample distribution, it is
unadvisable to use a highly shaped kernel due to increased uncertainty in
the mean partial derivatives.  Furthermore, even if we are fitting close to
the center of the distribution, that does not mean that the derivative
calculations were not skewed by a few nearby samples when fitting in a
local depression of the sample density (for example, near the center of a
donut-like distribution).</p>
<p>We model our confidence (<span class="math notranslate nohighlight">\(\gamma\)</span>) in the “shape” using a logistic
function (see <a class="reference internal" href="sofia_redux.toolkit.resampling.stretch_correction.html#sofia_redux.toolkit.resampling.stretch_correction" title="sofia_redux.toolkit.resampling.stretch_correction"><code class="xref py py-func docutils literal notranslate"><span class="pre">stretch_correction()</span></code></a>) that factors in <span class="math notranslate nohighlight">\(\chi_r^2\)</span>,
a measure of the sample density profile (<span class="math notranslate nohighlight">\(\rho\)</span>) at the fit
coordinate, and from the deviation of the fit coordinate from the center of
the sample distribution (<span class="math notranslate nohighlight">\(\sigma_d\)</span>):</p>
<div class="math notranslate nohighlight">
\[\gamma = \frac{2}
         {\left(
             {1 + (2^{exp(\sigma)} - 1)e^{\rho (1 - \chi_r^2)}}
         \right)^{1/exp(\sigma)}} - 1\]</div>
<p>The density <span class="math notranslate nohighlight">\(\rho\)</span> is calculated using <a class="reference internal" href="sofia_redux.toolkit.resampling.relative_density.html#sofia_redux.toolkit.resampling.relative_density" title="sofia_redux.toolkit.resampling.relative_density"><code class="xref py py-func docutils literal notranslate"><span class="pre">relative_density()</span></code></a> which
sets <span class="math notranslate nohighlight">\(\rho=1\)</span> when the samples are uniformly distributed,
<span class="math notranslate nohighlight">\(\rho &gt; 1\)</span> when the distribution is concentrated on the fit
coordinate, and <span class="math notranslate nohighlight">\(0 &lt; \rho &lt; 1\)</span> when the fitting in a local depression
of the distribution density.  The deviation (<span class="math notranslate nohighlight">\(\sigma_d\)</span>) is
calculated using <a class="reference internal" href="sofia_redux.toolkit.resampling.offset_variance.html#sofia_redux.toolkit.resampling.offset_variance" title="sofia_redux.toolkit.resampling.offset_variance"><code class="xref py py-func docutils literal notranslate"><span class="pre">offset_variance()</span></code></a>.</p>
<p>The confidence parameter has asymptotes at <span class="math notranslate nohighlight">\(\gamma = \pm 1\)</span>, is
equal to zero at <span class="math notranslate nohighlight">\(\chi_r^2=1\)</span>, is positive for <span class="math notranslate nohighlight">\(\chi_r^2 &gt; 1\)</span>,
and is negative for <span class="math notranslate nohighlight">\(\chi_r^2 &lt; 1\)</span>.  Also, the magnitude increases
with <span class="math notranslate nohighlight">\(\rho\)</span>, and decreases with <span class="math notranslate nohighlight">\(\sigma_d\)</span>.  The final shape
matrix is then defined as:</p>
<div class="math notranslate nohighlight">
\[A^{-1} = \beta\, U S^{\gamma} V^T\]</div>
<p>Note that as <span class="math notranslate nohighlight">\(\gamma \rightarrow 0\)</span>, the kernel approaches that of
a spheroid.  For <span class="math notranslate nohighlight">\(\chi_r^2 &gt; 1\)</span>, the kernel approaches
<span class="math notranslate nohighlight">\(\bar{g}^2\)</span>.  When <span class="math notranslate nohighlight">\(\chi_r^2 &lt; 1\)</span>, the kernel effectively
rotates so that the fit becomes increasingly sensitive to samples along
the direction of the derivative.  The overall size of the kernel remains
constant since <span class="math notranslate nohighlight">\(|S^{\gamma}| = |\bar{g}^2| = 1\)</span>.</p>
<p>Finally, the only remaining factor to calculate is the scaling factor
<span class="math notranslate nohighlight">\(\beta\)</span> which is given as:</p>
<div class="math notranslate nohighlight">
\[\beta = \left( \frac{\chi_r}{|A_0|} \right)^{1/K}\]</div>
<p>Note that this scaling has the effect of setting</p>
<div class="math notranslate nohighlight">
\[\frac{|A_0|}{|A|} = \chi_r\]</div>
<p>The user has the option of fixing the kernel in certain dimensions such
that <span class="math notranslate nohighlight">\({A_0}_{k, k} = A_{k, k}\)</span>.  If this is the case, for any fixed
dimension <span class="math notranslate nohighlight">\(k\)</span> we set:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}{U S^{\gamma} V^T}_{k, k} = 1\\{U S^{\gamma} V^T}_{k, i \neq k}^2 = 0\\{U S^{\gamma} V^T}_{i \neq k, k}^2 = 0\end{aligned}\end{align} \]</div>
<p>meaning the scaling is unaltered for dimensions <span class="math notranslate nohighlight">\(k\)</span>, and no rotation
will be applied to any other dimension with respect to <span class="math notranslate nohighlight">\(k\)</span>.  Since
the overall size must be controlled through fewer dimensions,
<span class="math notranslate nohighlight">\(\beta\)</span> must take the form of a diagonal matrix:</p>
<div class="math notranslate nohighlight">
\[diag(\beta)_{i \in fixed} = \frac{1}{2 \sigma_i^2}
,\,\,
diag(\beta)_{i \notin fixed} =
    \left(
    \frac{\chi_r |A_0|}{|{U S^{\gamma} V^T}|}
    \prod_{i \in fixed}{2 \sigma_i^2}
    \right)^{1 / (K - K_{fixed})}\]</div>
<p>Once again <span class="math notranslate nohighlight">\(A^{-1} = \beta\, U S^{\gamma} V^T\)</span>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>sigma</strong><span class="classifier">numpy.ndarray (n_dimensions,)</span></dt><dd><p>The standard deviations of the Gaussian for each dimensional component
used for the distance weighting of each sample in the initial fit.</p>
</dd>
<dt><strong>rchi2</strong><span class="classifier">float</span></dt><dd><p>The reduced chi-squared statistic of the fit.</p>
</dd>
<dt><strong>gradient_mscp</strong><span class="classifier">numpy.ndarray (n_dimensions, n_dimensions)</span></dt><dd><p>An array where gradient_mscp[i, j] = derivative[i] * derivative[j] in
dimensions i and j.  Please see <a class="reference internal" href="sofia_redux.toolkit.resampling.derivative_mscp.html#sofia_redux.toolkit.resampling.derivative_mscp" title="sofia_redux.toolkit.resampling.derivative_mscp"><code class="xref py py-func docutils literal notranslate"><span class="pre">derivative_mscp()</span></code></a> for further
information.  Must be Hermitian and real-valued (symmetric).</p>
</dd>
<dt><strong>density</strong><span class="classifier">float, optional</span></dt><dd><p>The local relative density of the samples around the fit coordinate.  A
value of 1 represents uniform distribution.  Values greater than 1
indicate clustering around the fitting point, and values less than 1
indicate that samples are sparsely distributed around the fitting
point.  Please see <a class="reference internal" href="sofia_redux.toolkit.resampling.relative_density.html#sofia_redux.toolkit.resampling.relative_density" title="sofia_redux.toolkit.resampling.relative_density"><code class="xref py py-func docutils literal notranslate"><span class="pre">relative_density()</span></code></a> for further information.</p>
</dd>
<dt><strong>variance_offset</strong><span class="classifier">float, optional</span></dt><dd><p>The variance at the fit coordinate determined from the sample
coordinate distribution. i.e., if a fit is performed at the center of
the sample distribution, the variance is zero.  If done at 2-sigma from
the sample distribution center, the variance is 4.</p>
</dd>
<dt><strong>fixed</strong><span class="classifier">numpy.ndarray of bool (n_dimensions,), optional</span></dt><dd><p>If supplied, <a class="reference external" href="https://docs.python.org/3/library/constants.html#True" title="(in Python v3.11)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">True</span></code></a> values indicate that the width of the Gaussian
along the corresponding axis should not be altered in the output
result.</p>
</dd>
<dt><strong>tolerance</strong><span class="classifier">float, optional</span></dt><dd><p>The threshold below which SVD values are considered zero when
determining the matrix rank of <a class="reference internal" href="sofia_redux.toolkit.resampling.derivative_mscp.html#sofia_redux.toolkit.resampling.derivative_mscp" title="sofia_redux.toolkit.resampling.derivative_mscp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">derivative_mscp</span></code></a>.  Please
see <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.linalg.matrix_rank.html#numpy.linalg.matrix_rank" title="(in NumPy v1.25)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.linalg.matrix_rank()</span></code></a> for further information.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><dl class="simple">
<dt><strong>shape_matrix</strong><span class="classifier">numpy.ndarray (n_dimensions, n_dimensions)</span></dt><dd><p>A matrix defining the shape of the weighting kernel required by
<a class="reference internal" href="sofia_redux.toolkit.resampling.calculate_adaptive_distance_weights_shaped.html#sofia_redux.toolkit.resampling.calculate_adaptive_distance_weights_shaped" title="sofia_redux.toolkit.resampling.calculate_adaptive_distance_weights_shaped"><code class="xref py py-func docutils literal notranslate"><span class="pre">calculate_adaptive_distance_weights_shaped()</span></code></a> to create a set of
weighting factors.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">shaped_adaptive_weight_matrix</a><ul>
<li><a class="reference internal" href="#sofia_redux.toolkit.resampling.shaped_adaptive_weight_matrix"><code class="docutils literal notranslate"><span class="pre">shaped_adaptive_weight_matrix()</span></code></a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../_sources/api/sofia_redux.toolkit.resampling.shaped_adaptive_weight_matrix.rst.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.1.2. &nbsp;
    Last built 13 Aug 2023. <br/>
  </p>
</footer>
  </body>
</html>