<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Convolution &#8212; sofia_redux v1.3.4.dev0</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=602f4d50"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Convolution Filters" href="filter.html" />
    <link rel="prev" title="Convolution (sofia_redux.toolkit.convolve)" href="index.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://www.sofia.usra.edu/"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="filter.html" title="Convolution Filters">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="index.html" title="Convolution (sofia_redux.toolkit.convolve)">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../../../index.html">sofia_redux v1.3.4.dev0</a>
	 &#187;
      </li>
      <li><a href="../../index.html" >SOFIA Redux</a> &#187;</li>
      <li><a href="../index.html" >sofia_redux.toolkit: Shared Utilities for SOFIA Pipelines</a> &#187;</li>
      <li><a href="index.html" accesskey="U">Convolution  (<code class="xref py py-obj docutils literal notranslate"><span class="pre">sofia_redux.toolkit.convolve</span></code>)</a> &#187;</li>
      
      <li>Convolution</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p>The <a class="reference internal" href="../index.html#module-sofia_redux.toolkit.convolve.kernel" title="sofia_redux.toolkit.convolve.kernel"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sofia_redux.toolkit.convolve.kernel</span></code></a> module contains the
<code class="xref py py-class docutils literal notranslate"><span class="pre">ConvolveBase</span></code> class, inheritors of <code class="xref py py-class docutils literal notranslate"><span class="pre">ConvolveBase</span></code>, and
functional wrappers for these classes.</p>
<section id="convolution">
<h1>Convolution<a class="headerlink" href="#convolution" title="Permalink to this heading">¶</a></h1>
<p>Currently the following classes may be used to filter and smooth data via
kernel convolution in N-dimensions:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../../../api/sofia_redux.toolkit.convolve.kernel.BoxConvolve.html#sofia_redux.toolkit.convolve.kernel.BoxConvolve" title="sofia_redux.toolkit.convolve.kernel.BoxConvolve"><code class="xref py py-class docutils literal notranslate"><span class="pre">BoxConvolve</span></code></a></p></li>
<li><p><a class="reference internal" href="../../../api/sofia_redux.toolkit.convolve.kernel.KernelConvolve.html#sofia_redux.toolkit.convolve.kernel.KernelConvolve" title="sofia_redux.toolkit.convolve.kernel.KernelConvolve"><code class="xref py py-class docutils literal notranslate"><span class="pre">KernelConvolve</span></code></a></p></li>
<li><p><a class="reference internal" href="../../../api/sofia_redux.toolkit.convolve.kernel.SavgolConvolve.html#sofia_redux.toolkit.convolve.kernel.SavgolConvolve" title="sofia_redux.toolkit.convolve.kernel.SavgolConvolve"><code class="xref py py-class docutils literal notranslate"><span class="pre">SavgolConvolve</span></code></a></p></li>
</ul>
</div></blockquote>
<p>All classes inherit from the <code class="xref py py-class docutils literal notranslate"><span class="pre">sofia_redux.toolkit.base.Model</span></code> class, shared
by <a class="reference internal" href="../../../api/sofia_redux.toolkit.fitting.polynomial.Polyfit.html#sofia_redux.toolkit.fitting.polynomial.Polyfit" title="sofia_redux.toolkit.fitting.polynomial.Polyfit"><code class="xref py py-class docutils literal notranslate"><span class="pre">sofia_redux.toolkit.fitting.polynomial.Polyfit</span></code></a>, so much of the statistical
functionality and robust outlier rejection will also apply in the following
section.  While there are many, many algorithms available for convolution in
the Python ecosystem already, the main functionality of these classes is that
they allow for:</p>
<blockquote>
<div><ul class="simple">
<li><p>N-dimensional</p></li>
<li><p>Interpolation over masked/NaN values</p></li>
<li><p>Error propagation</p></li>
<li><p>Statistical analysis and outlier rejection</p></li>
</ul>
</div></blockquote>
<p>This is achieved using a combination of linear interpolation with Delaunay
triangulation (when more than a single dimension is involved).  Therefore, if
none of the above features are required, it is recommended to use one of the
more standard algorithms for speed by avoiding the triangulation step.
Regardless, these algorithms are still quite fast.</p>
<section id="basic-functionality">
<h2>Basic Functionality<a class="headerlink" href="#basic-functionality" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">from</span> <span class="nn">sofia_redux.toolkit.convolve.kernel</span> <span class="kn">import</span> <span class="n">BoxConvolve</span>

<span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;imageio:coffee.png&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Gray scale</span>
<span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>  <span class="c1"># normalize for plotting</span>
<span class="n">mean_smooth</span> <span class="o">=</span> <span class="n">BoxConvolve</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>  <span class="c1"># an 11 x 11 box filter</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original Image&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mean_smooth</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Smoothed Image&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../../../_downloads/3c9a68f5004be93324347310fcf8c8e1/kernel-1.py"><code class="xref download docutils literal notranslate"><span class="pre">Source</span> <span class="pre">code</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/2dc0110ed4fd82cd257df059e265b746/kernel-1.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/61e7613088abb217fb69b892a0c1abb6/kernel-1.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/395947d840430cca62cef4024f16bf7b/kernel-1.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default">
<img alt="../../../_images/kernel-1.png" class="plot-directive" src="../../../_images/kernel-1.png" />
</figure>
<p>In the above example, <a class="reference internal" href="../../../api/sofia_redux.toolkit.convolve.kernel.BoxConvolve.html#sofia_redux.toolkit.convolve.kernel.BoxConvolve" title="sofia_redux.toolkit.convolve.kernel.BoxConvolve"><code class="xref py py-class docutils literal notranslate"><span class="pre">BoxConvolve</span></code></a> was used to set the value of each
pixel to the mean value of an (11, 11) box kernel centered on each pixel.
<a class="reference internal" href="../../../api/sofia_redux.toolkit.convolve.kernel.BoxConvolve.html#sofia_redux.toolkit.convolve.kernel.BoxConvolve" title="sofia_redux.toolkit.convolve.kernel.BoxConvolve"><code class="xref py py-class docutils literal notranslate"><span class="pre">BoxConvolve</span></code></a> is convenient, but only really just a child of
<a class="reference internal" href="../../../api/sofia_redux.toolkit.convolve.kernel.KernelConvolve.html#sofia_redux.toolkit.convolve.kernel.KernelConvolve" title="sofia_redux.toolkit.convolve.kernel.KernelConvolve"><code class="xref py py-class docutils literal notranslate"><span class="pre">KernelConvolve</span></code></a> which does the same thing except allows the user to
define their own smoothing kernel.  For example, we could create a user
defined Sobel filter to enhance edges in the image:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">from</span> <span class="nn">sofia_redux.toolkit.convolve.kernel</span> <span class="kn">import</span> <span class="n">KernelConvolve</span>

<span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;imageio:coffee.png&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Gray scale</span>
<span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>  <span class="c1"># normalize for plotting</span>

<span class="c1"># Create a Sobel filter</span>
<span class="n">sobel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]])</span>

<span class="c1"># Edges in 1 direction</span>
<span class="n">sx</span> <span class="o">=</span> <span class="n">KernelConvolve</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">sobel</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

<span class="c1"># Edges in the other</span>
<span class="n">sy</span> <span class="o">=</span> <span class="n">KernelConvolve</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">sobel</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

<span class="c1"># Edge amplitude</span>
<span class="n">sxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sxy</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray_r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Applying User Defined Kernel&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../../../_downloads/d1fb549acd05593a02083418eb17ac74/kernel-2.py"><code class="xref download docutils literal notranslate"><span class="pre">Source</span> <span class="pre">code</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/64f31c3ae41d94bc248a114475c33542/kernel-2.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/f96668b7e46a89d44f3daf1d5b87f766/kernel-2.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/27cc2a754aab6bc3c53774d6eeb3e96f/kernel-2.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default">
<img alt="../../../_images/kernel-2.png" class="plot-directive" src="../../../_images/kernel-2.png" />
</figure>
</section>
<section id="normalization">
<h2>Normalization<a class="headerlink" href="#normalization" title="Permalink to this heading">¶</a></h2>
<p>By default, a kernel (<span class="math notranslate nohighlight">\(K\)</span>) will be normalized before being
applied to the data such that</p>
<div class="math notranslate nohighlight">
\begin{eqnarray}
&amp; \hat{K} &amp; = \frac{K}{\sum{K}} \\
&amp; \sum{\hat{K}} &amp; = 1
\end{eqnarray}</div><p>However, this will only be done if <span class="math notranslate nohighlight">\(\sum{K} \neq 0\)</span>.  To keep the
original <span class="math notranslate nohighlight">\(K\)</span>, rather the normalized kernel <span class="math notranslate nohighlight">\(\hat{K}\)</span>, set
<code class="xref py py-obj docutils literal notranslate"><span class="pre">normalize=False</span></code> during initialization.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">KernelConvolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="masked-values-nan-handling-and-error-propagation">
<h2>Masked Values, NaN handling and Error Propagation<a class="headerlink" href="#masked-values-nan-handling-and-error-propagation" title="Permalink to this heading">¶</a></h2>
<p>Missing (NaN) values and masked values (those defined by the user to ignore)
are treated in the same way by the <code class="xref py py-class docutils literal notranslate"><span class="pre">ConvolveBase</span></code> class.  Linear
interpolation is first performed to generate values at these locations before
convolution.</p>
<p>Errors are propagated, consistent with the initial interpolation and
subsequent convolution.  For 1-dimensional data, standard linear interpolation
is performed.  For higher dimensions, Delaunay triangulation is used instead.
Therefore, one would expect 3 points used for the calculation of each
interpolant in 2 dimensions, 4 points in 3-dimensions etc.  This is reflected
during error propagation which will be contingent on the number of points and
structure of the tessellation.</p>
<p>In a similar way to most other classes in <code class="xref py py-mod docutils literal notranslate"><span class="pre">sofia_redux.toolkit.convolve</span></code>, NaNs
may be ignored (default), or propagated (<code class="xref py py-obj docutils literal notranslate"><span class="pre">ignorenans=False</span></code>).  Note however,
that NaNs will then propagate through the convolution operation, expanding
any NaN value through the entirety of the kernel.  I.e., if a single NaN is
present in the original data and convolved with a kernel of width 5, a NaN
region of width=5 will be present in the output convolution.</p>
<p>The example below uses a Savitzky-Golay filter which approximates polynomial
interpolation for regularly spaced data.  Large regions of the samples are
set to NaN values or masked out.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sofia_redux.toolkit.convolve.kernel</span> <span class="kn">import</span> <span class="n">SavgolConvolve</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="n">y</span> <span class="o">+=</span> <span class="n">noise</span>

<span class="c1"># Add NaN Values</span>
<span class="n">y</span><span class="p">[</span><span class="mi">300</span><span class="p">:</span><span class="mi">350</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="c1"># Mask certain values to be excluded from fit, but interpolated over</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[</span><span class="mi">75</span><span class="p">:</span><span class="mi">175</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">width</span> <span class="o">=</span> <span class="mi">31</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">SavgolConvolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">black_plot</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">black_plot</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">black_plot</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;NaN and Masked Value Handling&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">black_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Standard&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">300</span><span class="p">:</span><span class="mi">350</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mi">300</span><span class="p">:</span><span class="mi">350</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NaN handling&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">75</span><span class="p">:</span><span class="mi">175</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mi">75</span><span class="p">:</span><span class="mi">175</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span>
           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mask handling&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Error Propagation&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Error in Convolved values&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../../../_downloads/56d81140f061b7b1465a99aa83f41cef/kernel-3.py"><code class="xref download docutils literal notranslate"><span class="pre">Source</span> <span class="pre">code</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/fb73a4eb17a8e35acb87ce2ac5d97633/kernel-3.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/695a00776ef51ac5bbcc34620ff9cdca/kernel-3.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/c2ddd19a34e4154ba8eee4ed8b2cd3af/kernel-3.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default">
<img alt="../../../_images/kernel-3.png" class="plot-directive" src="../../../_images/kernel-3.png" />
</figure>
</section>
<section id="robust-outlier-rejection-and-statistics-for-the-convolve-class">
<h2>Robust Outlier Rejection and Statistics for the Convolve Class<a class="headerlink" href="#robust-outlier-rejection-and-statistics-for-the-convolve-class" title="Permalink to this heading">¶</a></h2>
<p>In a similar way to the <a class="reference internal" href="../../../api/sofia_redux.toolkit.fitting.polynomial.Polyfit.html#sofia_redux.toolkit.fitting.polynomial.Polyfit" title="sofia_redux.toolkit.fitting.polynomial.Polyfit"><code class="xref py py-class docutils literal notranslate"><span class="pre">sofia_redux.toolkit.fitting.polynomial.Polyfit</span></code></a> class,
children of <code class="xref py py-class docutils literal notranslate"><span class="pre">Convolve</span></code> may perform robust outlier rejection.  An outlier
is determined from the magnitude of the residual of the original data samples
to the convolved values.  Such outliers will be masked out and replaced with a
linear interpolation from values determined to be within the rejection
threshold. This process is repeated until no new outliers are found or one of
the other conditions described in robust outlier rejection for
<a class="reference internal" href="../../../api/sofia_redux.toolkit.fitting.polynomial.Polyfit.html#sofia_redux.toolkit.fitting.polynomial.Polyfit" title="sofia_redux.toolkit.fitting.polynomial.Polyfit"><code class="xref py py-class docutils literal notranslate"><span class="pre">sofia_redux.toolkit.fitting.polynomial.Polyfit</span></code></a> is met.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sofia_redux.toolkit.convolve.kernel</span> <span class="kn">import</span> <span class="n">SavgolConvolve</span>

<span class="c1"># Normalize for plotting</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;imageio:immunohistochemistry.png&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">image</span> <span class="o">-=</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">image</span> <span class="o">/=</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># Add some bad values</span>
<span class="n">rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span>
<span class="n">inds</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">100</span><span class="p">),</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">image</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">SavgolConvolve</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">s_robust</span> <span class="o">=</span> <span class="n">SavgolConvolve</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Corrupted original&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Standard convolution&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">s_robust</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Robust convolution&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">s_robust</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Robust errors&quot;</span><span class="p">)</span>

<span class="c1"># Display statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s_robust</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../../../_downloads/2e3fc9c00a2b9e64830236f83228e5fa/kernel-4.py"><code class="xref download docutils literal notranslate"><span class="pre">Source</span> <span class="pre">code</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/7efd9d8322d0e4ac8aa60bea89839c34/kernel-4.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/a1e31ff9cca72a31336a257b4d5958e6/kernel-4.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../../../_downloads/89af4fc1ef6ea2646e656e63e998965f/kernel-4.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default">
<img alt="../../../_images/kernel-4.png" class="plot-directive" src="../../../_images/kernel-4.png" />
</figure>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Name: SavgolConvolve

         Statistics
--------------------------------
Number of original points : 262144
           Number of NaNs : 0
       Number of outliers : 420
     Number of points fit : 261724
       Degrees of freedom : 261724
              Chi-Squared : 1841.870250
      Reduced Chi-Squared : 0.007037
      Goodness-of-fit (Q) : 0.000000
     RMS deviation of fit : 0.028076
  Outlier sigma threshold : 5
  eps (delta_sigma/sigma) : 0.01
               Iterations : 3
    Iteration termination : delta_rms/rms = 0.001941
</pre></div>
</div>
<p>The above example shows an artificially corrupted image, the effects of
convolution without removing outliers, a convolution with outliers removed,
and the resulting errors from the robust convolution algorithm.  Visually,
all outliers have been removed.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Convolution</a><ul>
<li><a class="reference internal" href="#basic-functionality">Basic Functionality</a></li>
<li><a class="reference internal" href="#normalization">Normalization</a></li>
<li><a class="reference internal" href="#masked-values-nan-handling-and-error-propagation">Masked Values, NaN handling and Error Propagation</a></li>
<li><a class="reference internal" href="#robust-outlier-rejection-and-statistics-for-the-convolve-class">Robust Outlier Rejection and Statistics for the Convolve Class</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../../../_sources/sofia_redux/toolkit/convolve/kernel.rst.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.1.2. &nbsp;
    Last built 13 Aug 2023. <br/>
  </p>
</footer>
  </body>
</html>