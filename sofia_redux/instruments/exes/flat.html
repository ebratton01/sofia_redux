<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>EXES flat processing steps &#8212; sofia_redux v1.3.4.dev0</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=602f4d50"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="sofia_redux.instruments.fifi_ls: FIFI-LS Data Reduction Algorithms" href="../fifi_ls/index.html" />
    <link rel="prev" title="Getting started" href="exes_reduction_guide.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://www.sofia.usra.edu/"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="../fifi_ls/index.html" title="sofia_redux.instruments.fifi_ls: FIFI-LS Data Reduction Algorithms">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="exes_reduction_guide.html" title="Getting started">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../../../index.html">sofia_redux v1.3.4.dev0</a>
	 &#187;
      </li>
      <li><a href="../../index.html" >SOFIA Redux</a> &#187;</li>
      <li><a href="../index.html" >sofia_redux.instruments: Instrument-Specific Algorithms</a> &#187;</li>
      <li><a href="index.html" accesskey="U">sofia_redux.instruments.exes: EXES Data Reduction Algorithms</a> &#187;</li>
      
      <li>EXES flat processing steps</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="exes-flat-processing-steps">
<h1>EXES flat processing steps<a class="headerlink" href="#exes-flat-processing-steps" title="Permalink to this heading">¶</a></h1>
<section id="make-flat">
<h2>Make Flat<a class="headerlink" href="#make-flat" title="Permalink to this heading">¶</a></h2>
<p>Flats are generated by the top level procedure <code class="docutils literal notranslate"><span class="pre">makeflat</span></code>:
use the card sequence to make a calibrated flat. Also
run <code class="docutils literal notranslate"><span class="pre">derive_tort</span></code> on black cards to determine distortion parameters</p>
<section id="steps">
<h3>Steps<a class="headerlink" href="#steps" title="Permalink to this heading">¶</a></h3>
<ol class="arabic">
<li><p>Calculate mean to find black frame (brightest)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">robustmeancomb</span></code></p></li>
</ul>
</li>
<li><p>Determine photon background at given wavelength &amp; temperature, as given
by the header values WAVENO0 and BB_TEMP respectively.</p></li>
<li><p>Calculate the RQE (Robust Quality Estimator?) for the black frame</p></li>
<li><p>Determine the sky and shiny frames</p></li>
<li><p>Combine all frames grouped by their label (black, shiny, sky, sky2)
through direct sum</p></li>
<li><p>Get flat values by mode</p>
<ul class="simple">
<li><p>Determined by <code class="docutils literal notranslate"><span class="pre">cardmode</span></code>, initially pulled from header key CARDMODE
but might be overriden by downstream logic.</p></li>
<li><dl class="simple">
<dt>Available values:</dt><dd><ul>
<li><p>BLK</p></li>
<li><p>NONE</p></li>
<li><p>SKY</p></li>
<li><p>SHINY</p></li>
<li><p>BLKSKY</p></li>
<li><p>OBJ</p></li>
<li><p>BLKOBJ</p></li>
<li><p>BLKSHINY</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</li>
<li><p>Check for correlation between card frames</p></li>
<li><p>Check for saturated pixels</p></li>
<li><p>Clean cards with <code class="docutils literal notranslate"><span class="pre">clean</span></code></p></li>
<li><p>Derive tort parameters with a 2D FFT with <code class="docutils literal notranslate"><span class="pre">derive_tort</span></code></p></li>
<li><p>Clean diff (<span class="math notranslate nohighlight">\(diff = black - sky\)</span>) frame with <code class="docutils literal notranslate"><span class="pre">clean</span></code></p></li>
<li><p>Calculate flat from</p>
<div class="math notranslate nohighlight">
\[flat = \frac{B_{\nu}(T_{card})}{black-sky}\]</div>
</li>
<li><p>Calculate variance frame from</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[variance = \frac{cardstd^2 * bnut^2}{(black-sky)^4}\]</div>
</div></blockquote>
</li>
<li><p>Update illumination frame with results of flat</p>
<blockquote>
<div><ul class="simple">
<li><p>Correct for tort with <code class="docutils literal notranslate"><span class="pre">tortcoord</span></code></p></li>
<li><p>Mark all out-of-bounds pixels as -1</p></li>
<li><p>Mark all pixels next to a bad pixel as 0</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Set the first plane of cards to the second plane</p></li>
<li><p>Tort the first card with echelon slit skewing  with <code class="docutils literal notranslate"><span class="pre">tort</span></code></p></li>
<li><p>Return flat</p></li>
</ol>
</section>
</section>
<section id="derive-tort">
<h2>Derive Tort<a class="headerlink" href="#derive-tort" title="Permalink to this heading">¶</a></h2>
<p>Sets distortion parameters by processing a blackbody flat frame. Identify
orders and illuminated regions. Generates the illumination frame which
indicates which regions of the undistored frame are illuminated.</p>
<section id="id1">
<h3>Steps<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h3>
<ol class="arabic">
<li><p>Undistort input flat data with <code class="docutils literal notranslate"><span class="pre">tort</span></code></p></li>
<li><p>For cross-dispersed data (HIGH-MED or HIGH-LOW) test and optimize distortion</p>
<blockquote>
<div><ul class="simple">
<li><p>Enhance the edges of the image</p></li>
<li><p>Generate 2D FFT of resulting image</p></li>
<li><p>Determine order spacing</p></li>
<li><p>Calculate the angle</p></li>
<li><p>If <span class="math notranslate nohighlight">\(|angle|&gt;0.001\)</span> update <code class="docutils literal notranslate"><span class="pre">krot</span></code> and rerun distortion correction</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Generate illumination frame</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}power = \sum_y undistorted\\threshold = threshold\_fraction \cdot max(power)\\\begin{split}illum = \left\{
    \begin{array}{c l}
        1 &amp; power &gt; threshold \\
        0 &amp; power &lt; threshold
    \end{array}
    \right\}\end{split}\end{aligned}\end{align} \]</div>
</div></blockquote>
</li>
<li><p>Update header with the edge definition parameters determined from the
undistorted flat.</p>
<blockquote>
<div><ul class="simple">
<li><p>NORDERS</p></li>
<li><p>ODRn_T1</p></li>
<li><p>ODRn_B1</p></li>
<li><p>ODRn_XR</p></li>
<li><p>ORDR_B</p></li>
<li><p>ORDR_T</p></li>
<li><p>ORDR_S</p></li>
<li><p>ORDR_E</p></li>
<li><p>EDGEDEG: Degree of the polynomial fit to order edges</p></li>
<li><p>ORDERS: Orders indentified’</p></li>
<li><p>SLTH_PIX: Slit height in pixels</p></li>
<li><p>SLTH_ARC: Slit height in arcseconds</p></li>
<li><p>SLTW_PIX: Slit width in pixels</p></li>
<li><p>SLTW_ARC: Slit width in arcseconds</p></li>
<li><p>RP: Resolving power</p></li>
<li><p>ROTATION: IDL rotate value</p></li>
</ul>
</div></blockquote>
</li>
</ol>
</section>
</section>
<section id="tort-coord">
<h2>Tort Coord<a class="headerlink" href="#tort-coord" title="Permalink to this heading">¶</a></h2>
<p>Calculates undistorted image coordinates. Uses the array size and
tort parameters from the header, along with knowledge of the instrument’s
optics, to calculate x- and y-coordinates in the undistorted array that
correspond the x- and y-coordinates of the raw array.</p>
<section id="main-parameters">
<h3>Main Parameters<a class="headerlink" href="#main-parameters" title="Permalink to this heading">¶</a></h3>
<p>HR = High Resolution
XD = Cross-Dispersed</p>
<section id="from-header">
<h4>From header<a class="headerlink" href="#from-header" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>KROT:</p></li>
<li><p>SLITROT: Slit rotation</p></li>
<li><p>HRG:</p></li>
<li><p>HRR: R number of echelon grating</p></li>
<li><p>XDG:</p></li>
<li><p>XDR: R number of cross-dispering element</p></li>
<li><p>XDDELTA:</p></li>
<li><p>PIXELWD: Pixel width</p></li>
<li><p>XDFL: Adjusted XD focal length</p></li>
<li><p>HRFL: Adjusted echelon focal length</p></li>
<li><p>DETROT: Detector rotation</p></li>
<li><p>BRL:</p></li>
<li><p>X0BRL:</p></li>
<li><p>Y0BRL:</p></li>
<li><p>XORDER1: First pixel of order 1</p></li>
<li><p>SPACING:</p></li>
<li><p>KROT: Rotation angle between chambers</p></li>
</ul>
</section>
<section id="calculations">
<h4>Calculations<a class="headerlink" href="#calculations" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(hr_{skew}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(xk_{skew}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(xd_{smile}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(xd_{nonlin}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(dxd_{skew}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(hr_{nonlin}\)</span></p></li>
</ul>
</section>
</section>
<section id="id2">
<h3>Steps<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Calculate parameters to characterize skew, echelon smile, and
whatever <code class="docutils literal notranslate"><span class="pre">xdnlin</span></code> is.</p></li>
</ol>
<blockquote>
<div><ul>
<li><p>For cross-dispersed modes</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}hr_{skew} &amp;= 2 * HRG * HRR * \tan(\theta_{slit})\\xk_{skew}  &amp;=  2 * XDG * XDR * \tan(\theta_{rot})\\xd_{smile}  &amp;=  \frac{-XDR  *  PIXELWD}{XDFL}\\xd_{disp}  &amp;=  \frac{XDFL  *  \left(XDR  -  XDDELTA \right)}{HRFL * HRR}\\xd_{nonlin}  &amp;=  -\left(XDR  +  \frac{1}{2 * XDR}\right)  * \frac{PIXELWD}{2 * XDFL}\\dxd_{skew}  &amp;=  \left(XDG + \frac{xd_{disp}}{2 * XDR}\right)  * \left( 1 + XDR^2 \right)  *  \frac{PIXELWD}{XDFL}\\hr_{nonlin}  &amp;=  -\left( HRR + \frac{1}{2 * HRR}\right)  * \frac{PIXELWD}{2 * HRFL}\\xorder_0  &amp;=  xorder_1  -  \frac{spacing}{2}\end{aligned}\end{align} \]</div>
</li>
<li><p>For longslit modes</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}xd_{skew}  &amp;=  2 * XDG * XDR  +  \tan(\theta_{slit})\\xd_{smile}  &amp;=  \frac{-XDR  *  PIXELWD}{XDFL}\\xd_{nonlin}  &amp;=  -\left(XDR + \frac{1}{2 * XDR}\right)  * \frac{PIXELWD}{2 * XDFL}\end{aligned}\end{align} \]</div>
</li>
</ul>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Apply skew, smile, and nonlinearity corrections</p></li>
</ol>
<blockquote>
<div><ul>
<li><p>Generate coordinate arrays with the same shape as a data frame, where
<span class="math notranslate nohighlight">\(x\)</span> has values of the distance along the x-axis and <span class="math notranslate nohighlight">\(y\)</span> has
values of the distance along the y-axis</p></li>
<li><p>Distance from each pixel to center</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}x_{dist}  =  x  -  \mbox{mean}(x)\\y_{dist}  =  y  -  \mbox{mean}(y)\end{aligned}\end{align} \]</div>
</li>
<li><p>For crossdispersed modes</p>
<ul>
<li><p>If handling skew</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}order  =  \frac{x  -  xorder_0}{spacing}\\y_{dist}  =  y_{dist} + hr_{skew}  *  spacing  *  \left(order - round (order)\right)\end{aligned}\end{align} \]</div>
</li>
<li><p>Correct for nonlinearity of echelon spectrum</p>
<div class="math notranslate nohighlight">
\[y_{cor}  =  y_{dist}  +  hr_{nonlin}  *  \left( y_{dist}^2  -  y_{mid}^2 \right)\]</div>
</li>
<li><p>Correct for skewing due to cross dispersion, k mirror, and smile</p>
<div class="math notranslate nohighlight">
\[x_{cor}  =  x_{dist}  +  xd_{disp}*y_{dist}  + xd_{skew}*y_{cor}  +  dxd_{skew}*x_{dist}*y_{cor}  +  xd_{smile}*y_{cor}^2\]</div>
</li>
<li><p>Correct for nonlinearity of xd spectrum</p>
<div class="math notranslate nohighlight">
\[x_{cor}  =  x_{cor}  +  xd_{nonlin}\left(x_{cor}^2  - x_{mid}^2 \right)\]</div>
</li>
</ul>
</li>
<li><p>For longslit mode, only correct distortions along x-axis</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}y_{cor}  =  y_{dist}\\x_{cor}  =  x_{dist}  +  xd_{nonlin} \left(x_{cor}^2  - x_{mid}^2 \right)\end{aligned}\end{align} \]</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>Apply barrel distortion correction</p></li>
</ol>
<blockquote>
<div><div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}barrel  =  1  -  BRL  *  \frac{(x_{cor} - X0BRL)^2  + (y_{cor}-Y0BRL)^2}{x_{mid}^3}\\x_{cor}  =  x_{cor}  *  barrel\\y_{cor}  =  y_{cor}  *  barrel\end{aligned}\end{align} \]</div>
</div></blockquote>
<ol class="arabic" start="4">
<li><p>Rotate by detector rotation angle (DETROT).</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}u  =  -x_{cor}\cos(DETROT) + y_{cor}\sin(DETROT)  +  x_{mid}\\v  =  -y_{cor}\cos(DETROT) - x_{cor}\sin(DETROT)  +  y_{mid}\end{aligned}\end{align} \]</div>
</li>
</ol>
</section>
</section>
<section id="tort">
<h2>Tort<a class="headerlink" href="#tort" title="Permalink to this heading">¶</a></h2>
<p>Corrects image for optical distortion. Uses <code class="docutils literal notranslate"><span class="pre">tortcoord</span></code> to generate
undistorted coordinates from raw pixel coordinates and distortion parameters
in the header. The image is then interpolated onto the undistorted
coordinates. If the variance is provided, it is also interpolated onto
undistorted coordinates.</p>
<section id="id3">
<h3>Main Parameters<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
</section>
<section id="id4">
<h3>Steps<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Convert raw coordinates to undistorted coordinates with <code class="docutils literal notranslate"><span class="pre">tortcoord</span></code></p></li>
<li><p>Loop over each frame of the image</p></li>
<li><p>Interpolate each frame of the image onto new undistorted coordinates</p></li>
<li><p>Do same for variance</p></li>
<li><p>Return undistorted image</p></li>
</ol>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">EXES flat processing steps</a><ul>
<li><a class="reference internal" href="#make-flat">Make Flat</a><ul>
<li><a class="reference internal" href="#steps">Steps</a></li>
</ul>
</li>
<li><a class="reference internal" href="#derive-tort">Derive Tort</a><ul>
<li><a class="reference internal" href="#id1">Steps</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tort-coord">Tort Coord</a><ul>
<li><a class="reference internal" href="#main-parameters">Main Parameters</a><ul>
<li><a class="reference internal" href="#from-header">From header</a></li>
<li><a class="reference internal" href="#calculations">Calculations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id2">Steps</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tort">Tort</a><ul>
<li><a class="reference internal" href="#id3">Main Parameters</a></li>
<li><a class="reference internal" href="#id4">Steps</a></li>
</ul>
</li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../../../_sources/sofia_redux/instruments/exes/flat.rst.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.1.2. &nbsp;
    Last built 13 Aug 2023. <br/>
  </p>
</footer>
  </body>
</html>