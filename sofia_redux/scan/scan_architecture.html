<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Main Classes &#8212; sofia_redux v1.3.4.dev0</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    
    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=602f4d50"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="icon" href="../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Usage" href="scan_usage.html" />
    <link rel="prev" title="Algorithm" href="scan_description.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://www.sofia.usra.edu/"></a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="scan_usage.html" title="Usage">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="scan_description.html" title="Algorithm">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../../index.html">sofia_redux v1.3.4.dev0</a>
	 &#187;
      </li>
      <li><a href="../index.html" >SOFIA Redux</a> &#187;</li>
      <li><a href="index.html" accesskey="U">sofia_redux.scan: Scan Mode Algorithms for SOFIA Pipelines</a> &#187;</li>
      
      <li>Main Classes</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p>The scan package (<code class="xref py py-obj docutils literal notranslate"><span class="pre">sofia_redux.scan</span></code>) package implements
an iterative map reconstruction algorithm, for reducing continuously
scanned observations.  It is implemented in pure Python, with <code class="xref py py-obj docutils literal notranslate"><span class="pre">numba</span></code>
just-in-time (JIT) compilation support for heavy numerical processes,
and multiprocessing support for parallelizable loops.</p>
<section id="main-classes">
<h1>Main Classes<a class="headerlink" href="#main-classes" title="Permalink to this heading">¶</a></h1>
<p>The primary data structures for modeling an instrument in the scan package
are listed below, and their relationships are diagrammed in
<a class="reference internal" href="#scan-data"><span class="std std-numref">Fig. 131</span></a>.</p>
<ul class="simple">
<li><p><strong>ChannelData</strong>: an class representing a set of detector channel (pixels).
A channel has properties, such as gains, flags, and weights etc.</p></li>
<li><p><strong>ChannelGroup</strong>: A generic grouping of detector channels.  This is
implemented as a wrapper around the <em>ChannelData</em> class, with access
to specific channel indices held by the underlying arrays.</p></li>
<li><p><strong>Channels</strong>: An class representing all the available channels for
an instrument.</p></li>
<li><p><strong>Frames</strong>: A data structure that represents the readout values of all
<em>Channels</em> at a given time sample, together with software flags, and
associated properties (e.g. gain, transmission, weight etc.)</p></li>
<li><p><strong>Integration</strong>: A collection of <em>Frames</em> that comprises a contiguous
dataset, for which one can assume overall stability of gains and
noise properties. Typically an <em>Integration</em> is a few minutes of data.</p></li>
<li><p><strong>Scan</strong>: A collection of <em>Integrations</em> that comprise a single file
or observing entity. For HAWC+, a scan is a data file, and by default
each scan contains just one integration. However, it is possible to break
<em>Scans</em> into multiple <em>Integrations</em>, if desired.</p></li>
<li><p><strong>Signal</strong>: An object representing some time-variant scalar signal
that may (or may not) produce a response in the detector channels.
For example, the chopper motion in the ‘x’ direction is such a
<em>Signal</em> (available as ‘chopper-x’) that may be used during the
reduction.</p></li>
<li><p><strong>Dependents</strong>: An object that keeps track of the number of model
parameters derived from each <em>Frame</em> and each <em>Channel</em>. It measures
the lost degrees of freedom due to modeling (and filtering) of the
raw signals, and it is critical for calculating proper noise weights
that remain stable in a iterated framework. Failure to count
Dependents correctly and accurately can result in divergent
weighting, which in turn manifests in over-flagging and/or severe
mapping artifacts. Every modeling step keeps track of its own
dependents this way in the analysis.</p></li>
<li><p><strong>ChannelDivision</strong>: A collection of <em>ChannelGroups</em> according to some
grouping principle. For example, the channels that are read out through
a particular SQUID multiplexer (MUX) comprise a <em>ChannelGroup</em> for that
particular SQUID. The collection of MUX groups over all the SQUID MUXes
constitute a <em>ChannelDivision</em>.</p></li>
<li><p><strong>Mode</strong>: An object that represents how a <em>ChannelGroup</em> responds to
a <em>Signal</em>.</p></li>
<li><p><strong>Modality</strong>: A collection of <em>Modes</em> of a common type. Just as <em>Modes</em>
are inherently linked to a <em>ChannelGroup</em>, <em>Modalities</em> are linked to
<em>ChannelDivisions</em>.</p></li>
</ul>
<figure class="align-default" id="id1">
<span id="scan-data"></span><img alt="UML class diagram of principal scan data classes." src="../../_images/scan_data1.png" />
<figcaption>
<p><span class="caption-number">Fig. 131 </span><span class="caption-text">Principal scan data classes.  Channels has a set of ChannelDivisions.
ChannelDivision is composed of ChannelGroups, which inherit from
ChannelData.  Modality depends on ChannelDivision and is composed of
Modes.  Mode depends on ChannelGroup and depends on Signal.  Scan is
composed of Integrations.  Integration has a collection of Frames,
Signals, and ChannelData.  Frame and ChannelData have a
collection of Dependents; Signal depends on Dependents.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>For example, the HAWC instrument is modeled as a set of Channels, i.e. pixels,
for which each has a row and a column index within a subarray.  The raw
timestream of data from the channels is modeled as a set of Frames,
contained within an Integration. To decorrelate the rows of
the HAWC detector, a Modality is created from “rows” ChannelDivision. This
modality contains Modes generated for each ChannelGroup with a particular row
index (row=0, row=1, etc.).  Each mode is associated with a Signal, which
contains the correlated signals for the row, determines and updates gain
increments, subtracts them from the time samples in the Frames, and updates the
dependents associated with the Frames and ChannelData.</p>
<p>The reduction process is run from the class <strong>Reduction</strong>, which performs
the reduction in a <strong>Pipeline</strong> instance, and
produces a <strong>SourceModel</strong> (see <a class="reference internal" href="#scan-process"><span class="std std-numref">Fig. 132</span></a>).
A <em>Reduction</em> may create a set of sub-reductions to run in parallel,
for processing a group of separate but associated source models.  These
sub-reductions are used, for example, to process HAWC+ R and T subarrays
separately for Scan-Pol data.</p>
<p>Each <em>Pipeline</em> is in charge of reducing a group of <em>Scans</em>
mostly independently (apart from resulting in a combined <em>SourceModel</em>).
The <em>Pipeline</em> iteratively reduces each <em>Scan</em> by repeatedly executing
a set of tasks, defined by a <strong>Configuration</strong> class.  Metadata for
the observation, including the <em>Configuration</em> and instrument information,
is managed by an <strong>Info</strong> class associated with the <em>Reduction</em>.</p>
<figure class="align-default" id="id2">
<span id="scan-process"></span><img alt="UML class diagram of principal scan processing classes." src="../../_images/scan_process1.png" />
<figcaption>
<p><span class="caption-number">Fig. 132 </span><span class="caption-text">Principal scan processing classes.  A Reduction creates a Pipeline or,
optionally, sub-reductions that create their own Pipelines.  The
Reduction depends on Info, which contains a Configuration.  Pipeline
depends on Configuration and on SourceModel, and has an aggregation
of Scans to reduce.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="top-level-call-sequence">
<h1>Top-Level Call Sequence<a class="headerlink" href="#top-level-call-sequence" title="Permalink to this heading">¶</a></h1>
<p>The symbol <span class="math notranslate nohighlight">\(\circlearrowright\)</span> indicates a loop,
<span class="math notranslate nohighlight">\(\pitchfork\)</span> (fork) indicates a parallel processing fork,
square brackets are methods that are called optionally (based on the
current configuration settings). Only the most relevant calls are shown.
Ellipses (…) are used to indicate that the call sequence may contain
additional elements not explicitly listed here and/or added by the
particular subclass implementations.</p>
<p>Call sequence from <strong>sofia_redux.scan.reduction.Reduction</strong>:</p>
<ol class="arabic simple">
<li><p>Reduction.__init__()</p>
<ol class="loweralpha simple">
<li><p>Info.instance_from_intrument_name()</p></li>
<li><p>Info.read_configuration()</p></li>
<li><p>Info.get_channels_instance()</p></li>
</ol>
</li>
<li><p>Reduction.run()</p>
<ol class="loweralpha simple">
<li><p>Info.split_reduction()</p></li>
<li><p><span class="math notranslate nohighlight">\(\pitchfork\)</span> Channels.read_scan()</p>
<ol class="lowerroman simple">
<li><p>Channels.get_scan_instance()</p></li>
<li><p>Scan.read(filename: str)</p></li>
<li><p>Scan.validate()</p>
<ol class="upperalpha simple">
<li><p><span class="math notranslate nohighlight">\(\circlearrowright\)</span> Integration.validate() …</p>
<ol class="arabic simple">
<li><p>Frames.validate() …</p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.fill_gaps() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.notch_filter() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.detect_chopper() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.select_frames() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.velocity_clip() /
acceleration_clip() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> KillFilter.apply() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.check_range() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.downsample() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p>Integration.trim()</p></li>
<li><p>Integration.detector_stage()</p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.set_tau() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.set_scaling() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.slim() <span class="math notranslate nohighlight">\(]\)</span></p>
<ol class="loweralpha simple">
<li><p>Channels.slim()</p></li>
<li><p>Frames.slim()</p></li>
</ol>
</li>
<li><p><span class="math notranslate nohighlight">\([\)</span> <span class="math notranslate nohighlight">\(\circlearrowright\)</span> Frame.jackknife() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p>Integration.bootstrap_weights()</p></li>
</ol>
</li>
<li><p>Channels.calculate_overlaps()</p></li>
</ol>
</li>
</ol>
</li>
<li><p>Reduction.validate()</p>
<ol class="lowerroman simple">
<li><p>Info.validate_scans()</p></li>
<li><p>Reduction.init_source_model()</p></li>
<li><p>Reduction.init_pipelines()</p></li>
</ol>
</li>
<li><p><span class="math notranslate nohighlight">\(\pitchfork\)</span> Reduction.reduce()</p>
<ol class="lowerroman simple">
<li><p><span class="math notranslate nohighlight">\(\circlearrowright\)</span> Reduction.iterate()</p>
<ol class="upperalpha simple">
<li><p>Pipeline.set_ordering()</p></li>
<li><p><span class="math notranslate nohighlight">\(\pitchfork\)</span> Pipeline.iterate()</p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\(\circlearrowright\)</span> Scan.perform(task: str)</p>
<ol class="loweralpha simple">
<li><p><span class="math notranslate nohighlight">\(\circlearrowright\)</span> <strong>Integration.perform(task: str)</strong></p>
<ol class="lowerroman simple">
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.dejump() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.remove_offsets() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.remove_drifts() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.decorrelate(modality, …) <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.get_channel_weights() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.get_time_weights() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.despike() <span class="math notranslate nohighlight">\(]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Integration.filter.apply() <span class="math notranslate nohighlight">\(]\)</span></p></li>
</ol>
</li>
</ol>
</li>
<li><p><span class="math notranslate nohighlight">\(\circlearrowright\)</span> Pipeline.update_source(Scan)</p>
<ol class="loweralpha simple">
<li><p>SourceModel.renew()</p></li>
<li><p><span class="math notranslate nohighlight">\(\circlearrowright\)</span> SourceModel.add_integration(Integration)</p></li>
<li><p>SourceModel.process_scan(Scan) …</p></li>
<li><p>SourceModel.add_model(SourceModel)</p></li>
<li><p>SourceModel.post_process_scan(Scan)</p></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li><p><span class="math notranslate nohighlight">\([\)</span> Reduction.write_products() <span class="math notranslate nohighlight">\(]\)</span></p></li>
</ol>
</li>
</ol>
</li>
</ol>
<p>Most of the number crunching happens under the
<em>Integration.perform</em> call, highlighted in bold-face. It is
a switch method that will make the relevant processing calls, in the
sequence defined by the current pipeline configuration.</p>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Main Classes</a></li>
<li><a class="reference internal" href="#top-level-call-sequence">Top-Level Call Sequence</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../../_sources/sofia_redux/scan/scan_architecture.rst.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.1.2. &nbsp;
    Last built 13 Aug 2023. <br/>
  </p>
</footer>
  </body>
</html>